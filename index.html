<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";

        // ØªÙƒÙˆÙŠÙ† Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCqqEu0G1rss9Qh__PYp50iXVby0_kLLE8",
            authDomain: "students-data-4e124.firebaseapp.com",
            projectId: "students-data-4e124",
            storageBucket: "students-data-4e124.firebasestorage.app",
            messagingSenderId: "1054134348411",
            appId: "1:1054134348411:web:020594a563e5bb193e90de",
            measurementId: "G-BCNQ7M9GC3",
            databaseURL: "https://students-data-4e124-default-rtdb.firebaseio.com" // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        // Ø¬Ø¹Ù„ ÙˆØ¸Ø§Ø¦Ù Firebase Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
        window.firebaseApp = app;
        window.initFirebase = initializeApp;
        window.getDatabase = getDatabase;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbChild = child;
        window.dbOnValue = onValue;
    </script>
    <script src="firebase-api.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --pink-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            --blue-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --purple-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            --bg-dark: #1a1d29;
            --card-dark: #2d3142;
            --text-light: #ffffff;
            --border-dark: #404654;
            --shadow-dark: 0 10px 30px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Segoe UI', 'Cairo', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #8e44ad 50%, #3498db 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-dark);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .nav-tabs {
            background: linear-gradient(135deg, #2d3142 0%, #1a1d29 100%);
            padding: 1rem 2rem;
            margin: 2rem auto 0;
            max-width: 1400px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .nav-tabs::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4facfe, #00f2fe, #4facfe);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: -200% 0; }
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-right: 2rem;
        }

        .nav-logo {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .nav-title h3 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--text-light);
            font-weight: bold;
        }

        .nav-title p {
            margin: 0;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
            font-style: italic;
        }

        .nav-menu {
            display: flex;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
        }

        .nav-tab {
            padding: 0.8rem 1.2rem;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            color: var(--text-light);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 12px;
            min-width: 100px;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            border-radius: 12px;
            transition: all 0.3s ease;
            z-index: -1;
            opacity: 0;
        }

        .nav-tab.active::before {
            opacity: 1;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .nav-tab:hover::before {
            opacity: 1;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.3), rgba(0, 242, 254, 0.3));
        }

        .nav-tab.active {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-tab:hover {
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .nav-tab.active .nav-tab-icon {
            transform: scale(1.2);
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
        }

        .nav-tab.active .nav-tab-text {
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .nav-tab-icon {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        .nav-tab:hover .nav-tab-icon {
            transform: scale(1.2);
        }

        .nav-tab-text {
            font-weight: 500;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: 2rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .user-name {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-light);
        }

        .user-role {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }

        .user-avatar {
            font-size: 1.5rem;
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grade-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .grade-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-dark);
        }

        .grade-card:nth-child(2) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .grade-card:nth-child(3) {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .grade-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transition: all 0.3s ease;
        }

        .grade-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .grade-card:hover::before {
            top: -30%;
            right: -30%;
        }

        .grade-card h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .grade-card p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .grade-number {
            font-size: 3rem;
            font-weight: bold;
            margin: 1rem 0;
            position: relative;
            z-index: 1;
        }

        .classes-grid {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
            animation: slideDown 0.5s ease;
        }

        .classes-grid.active {
            display: grid;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .class-card {
            background: var(--card-dark);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--border-dark);
            position: relative;
            overflow: hidden;
        }

        .class-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--blue-gradient);
            transition: all 0.3s ease;
            z-index: -1;
        }

        .class-card:hover::before {
            left: 0;
        }

        .class-card:hover {
            color: white;
            transform: scale(1.05);
            border-color: transparent;
        }

        .class-card h4 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .class-card p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
            padding: 2rem 0;
        }

        .stat-card {
            background: var(--card-dark);
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow-dark);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .stat-card-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 1rem;
        }

        .stat-card:nth-child(1) .stat-card-icon {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card:nth-child(2) .stat-card-icon {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .stat-card:nth-child(3) .stat-card-icon {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }

        .stat-card:nth-child(4) .stat-card-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }

        .stat-card .label {
            font-size: 1rem;
            opacity: 0.8;
            color: white;
        }

        .controls {
            background: var(--card-dark);
            padding: 2rem;
            border-radius: 15px;
            margin: 2rem 0;
            box-shadow: var(--shadow-dark);
        }

        .controls-row {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .controls-row:last-child {
            margin-bottom: 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .btn-primary {
            background: var(--blue-gradient);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: white;
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--text-light);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--card-dark);
            color: var(--text-light);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        select.form-control {
            cursor: pointer;
        }

        .table-responsive {
            overflow-x: auto;
            margin: 2rem 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-dark);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-dark);
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-dark);
        }

        .table th {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody tr {
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.01);
        }

        .student-name {
            cursor: pointer;
            color: #4facfe;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .student-name:hover {
            color: #00f2fe;
            text-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-dark);
            padding: 2rem;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-dark);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .close:hover {
            color: #ff6b6b;
            transform: scale(1.2);
        }

        .student-card {
            background: var(--card-dark);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: var(--shadow-dark);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .student-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--blue-gradient);
        }

        .student-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-item {
            background: rgba(79, 172, 254, 0.1);
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
        }

        .info-item h4 {
            color: #4facfe;
            margin-bottom: 0.5rem;
        }

        .info-item p {
            color: var(--text-light);
        }

        .grades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .grade-item {
            background: var(--card-dark);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--border-dark);
        }

        .grade-item.pass {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }

        .grade-item.fail {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .grade-item h5 {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .grade-item .grade {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .grade-item.pass .grade {
            color: #4ecdc4;
        }

        .grade-item.fail .grade {
            color: #ff6b6b;
        }

        .attendance-summary {
            background: rgba(79, 172, 254, 0.1);
            padding: 1.5rem;
            border-radius: 15px;
            margin: 1rem 0;
            text-align: center;
        }

        .attendance-percentage {
            font-size: 3rem;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 0.5rem;
        }

        .student-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 1rem 0;
        }

        .student-status.pass {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
        }

        .student-status.fail {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .student-status.pending {
            background: linear-gradient(135deg, #9aa5b1 0%, #6b7280 100%);
            color: white;
        }

        /* Student Card Styles */
        .student-card {
            max-width: 800px;
            width: 90%;
        }

        .student-info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .info-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-section h4 {
            color: #4facfe;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-row .label {
            font-weight: bold;
            color: #00d4ff;
        }

        /* grades UI removed from student card */

        .semester-grades h5 {
            color: #00d4ff;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .grade-row {
            display: flex;
            justify-content: space-between;
            padding: 0.3rem 0;
            font-size: 0.9rem;
        }

        .card-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #fff;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #ff6b6b;
        }

        @media (max-width: 768px) {
            .student-info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .card-actions {
                flex-direction: column;
            }
        }

        /* Student Link Styles */
        .student-link {
            color: #4facfe;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .student-link:hover {
            color: #00d4ff;
            text-decoration: underline;
        }

        .failed-subjects { display: none; }

        .failed-subjects h4 {
            color: #ff6b6b;
            margin-bottom: 0.5rem;
        }

        .notes-section {
            margin: 2rem 0;
        }

        .notes-section textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            background: var(--card-dark);
            color: var(--text-light);
            font-family: inherit;
            resize: vertical;
        }

        .notes-section textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .certificate-container {
            width: 21cm;
            height: 29.7cm;
            margin: 0 auto;
            background: white;
            color: black;
            padding: 2cm;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            position: relative;
        }

        .certificate-quarter {
            width: 100%;
            height: auto;
            border: 2px solid #333;
            padding: 1.5rem 1.25rem 2rem; /* extend block slightly downward */
            margin-bottom: 1.2rem;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .certificate-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .certificate-header h2 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .certificate-header h3 {
            font-size: 1rem;
            margin-bottom: 0.3rem;
        }

        .certificate-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.35rem; /* tighter vertical spacing */
        }

        .certificate-row {
            display: flex;
            justify-content: flex-start; /* bring values closer to labels */
            align-items: center;
            margin-bottom: 0.4rem;
            gap: 1rem; /* consistent small gap */
            flex-wrap: wrap;
        }

        /* make label spans fixed width for consistent closeness */
        .certificate-row span:first-child,
        .certificate-row span:nth-child(3) {
            min-width: 90px;
            font-weight: 600;
        }

        .certificate-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            opacity: 0.6;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .report-section {
            margin: 2rem 0;
        }

        .report-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .report-icon {
            font-size: 2rem;
        }

        .report-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .top-student {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--card-dark);
            border-radius: 10px;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .top-student:hover {
            transform: translateX(-5px);
            box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
        }

        .student-rank {
            background: var(--blue-gradient);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .student-rank.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-gradient);
            color: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow-dark);
            z-index: 2000;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--danger-gradient);
        }

        .toast.warning {
            background: var(--warning-gradient);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .nav-tabs {
                margin: 1rem auto 0;
            }

            .nav-tab {
                min-width: 100px;
                padding: 0.8rem;
                font-size: 0.9rem;
            }

            .grade-cards {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .modal-content {
                width: 95%;
                padding: 1rem;
            }

            .student-info-grid {
                grid-template-columns: 1fr;
            }

            .grades-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <style media="print">
        /* Print-only styles */
        @page {
            size: A4;
            margin: 0;
        }
        
        body * { visibility: hidden; }
        
        /* Attendance print styles */
        #attendance, #attendance * { visibility: visible; }
        #attendance { position: absolute; left: 0; top: 0; width: 100%; }
        
        /* Certificate print styles */
        #certificate-preview, #certificate-preview * { visibility: visible !important; }
        #certificate-preview { 
            position: absolute; 
            left: 0; 
            top: 0; 
            width: 100%;
            background: white !important;
        }
        .certificate-container { 
            margin: 0 auto;
            box-shadow: none !important;
            background: white !important;
            width: 21cm !important;
            min-height: 29.7cm !important;
        }
        .certificate-quarter {
            border: 1px solid #000 !important;
            background: white !important;
            color: black !important;
        }
        
        /* Hide UI elements in print */
        .btn, .nav-tabs, .theme-toggle, .header, .controls, .footer { display: none !important; }
        
        /* Table print styles */
        .table { border: 1px solid #000 !important; }
        .table th, .table td { 
            border: 1px solid #000 !important; 
            color: #000 !important;
            background: white !important;
        }
        .table th { background: #f5f5f5 !important; }
        .student-status { color: #000 !important; background: none !important; border: 1px solid #000; }
    </style>
    <style>
@media print {
    @page {
        size: A4;
        margin: 2cm;
    }
    body {
        margin: 0;
        padding: 0;
        background: white;
        font-family: 'Traditional Arabic', 'Times New Roman', serif;
    }
    #certificate-container {
        width: 100%;
        margin: 0;
        padding: 0;
        direction: rtl;
        background: white;
    }
    .certificate-header {
        text-align: center;
        margin-bottom: 1cm;
    }
    .certificate-header h3 {
        margin: 0.2cm 0;
    }
    .certificate-title {
        text-align: center;
        margin: 1cm 0;
        font-size: 24px;
    }
    .certificate-content {
        line-height: 1.8;
    }
    .certificate-content p {
        margin: 0.3cm 0;
    }
    .grades-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5cm;
    }
    .grades-table th,
    .grades-table td {
        border: 1px solid black;
        padding: 8px;
        text-align: center;
    }
    .signature-section {
        margin-top: 2cm;
        display: flex;
        justify-content: space-between;
    }
}
    </style>
</head>
<body>
    <div id="password-overlay" style="
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #1a1d29e0; z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="background: #2d3142; padding: 2rem 2.5rem; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); text-align: center;">
        <h2 style="color: #4facfe; margin-bottom: 1.5rem;">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input type="password" id="page-password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-bottom: 1rem; font-size: 1.2rem;">
        <button onclick="checkPassword()" class="btn btn-primary" style="width: 100%;">Ø¯Ø®ÙˆÙ„</button>
        <div id="password-error" style="color: #ff6b6b; margin-top: 1rem; display: none;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!</div>
        </div>
    </div>

    <header class="header">
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
        <img src="logo1.png" alt="Logo" style="position: absolute; top: 0px; right: 0px; width: 160px; height: 160px; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
        <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¤ÙˆÙ† Ø·Ù„Ø§Ø¨</h1>
        <p>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ø­Ù…Ø¯ÙŠ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© Ø¨Ù†ÙŠÙ†</p>
    </header>

    <nav class="nav-tabs">
        <div class="nav-brand">
            <div class="nav-logo">ğŸ“</div>
        </div>
        <div class="nav-menu">
            <button class="nav-tab active" onclick="showTab('dashboard')">
                <span class="nav-tab-icon">ğŸ </span>
                <span class="nav-tab-text">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
            </button>
            <button class="nav-tab" onclick="showTab('students')">
                <span class="nav-tab-icon">ğŸ‘¥</span>
                <span class="nav-tab-text">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</span>
            </button>
            <button class="nav-tab" onclick="showTab('attendance')">
                <span class="nav-tab-icon">ğŸ“…</span>
                <span class="nav-tab-text">Ø§Ù„Ø­Ø¶ÙˆØ±</span>
            </button>
            <button class="nav-tab" onclick="showTab('grades')">
                <span class="nav-tab-icon">â­</span>
                <span class="nav-tab-text">Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span>
            </button>
            <button class="nav-tab" onclick="showTab('reports')">
                <span class="nav-tab-icon">ğŸ“Š</span>
                <span class="nav-tab-text">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
            </button>
            <button class="nav-tab" onclick="showTab('certificates')">
                <span class="nav-tab-icon">ğŸ†</span>
                <span class="nav-tab-text">Ø§Ù„Ø¥ÙØ§Ø¯Ø§Øª ÙˆØ¨ÙŠØ§Ù† Ø§Ù„Ù†Ø¬Ø§Ø­</span>
            </button>
            <button class="nav-tab" onclick="showTab('settings')">
                <span class="nav-tab-icon">âš™ï¸</span>
                <span class="nav-tab-text">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
            </button>
        </div>
        <div class="nav-user">
            <div class="user-info">
                <span class="user-name">Youssef Ellawaty</span>
                <span class="user-role">Ù…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…</span>
            </div>
            <div class="user-avatar">ğŸ‘¨â€ğŸ’»</div>
        </div>
    </nav>

    <main class="container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grade-cards">
                <div class="grade-card" onclick="showClasses(1)">
                    <h3>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</h3>
                    <div class="grade-number" id="grade1-count">1</div>
                    <p>15 ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ</p>
                    <p id="grade1-students">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                </div>
                <div class="grade-card" onclick="showClasses(2)">
                    <h3>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</h3>
                    <div class="grade-number" id="grade2-count">0</div>
                    <p>12 ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ</p>
                    <p id="grade2-students">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                </div>
                <div class="grade-card" onclick="showClasses(3)">
                    <h3>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</h3>
                    <div class="grade-number" id="grade3-count">0</div>
                    <p>12 ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ</p>
                    <p id="grade3-students">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</p>
                </div>
            </div>

            <div id="classes-section" style="display: none;">
                <h2 style="text-align: center; margin: 2rem 0;">Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
                <div class="classes-grid" id="classes-grid"></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-icon">ğŸ‘¥</div>
                    <div class="number" id="total-students">1</div>
                    <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">âŒ</div>
                    <div class="number" id="total-absent">0</div>
                    <div class="label">Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">âœ…</div>
                    <div class="number" id="total-present">1</div>
                    <div class="label">Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">ğŸ“Š</div>
                    <div class="number" id="attendance-percentage">100%</div>
                    <div class="label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                </div>
            </div>
        </div>

        <!-- Students Tab -->
        <div id="students" class="tab-content">
            <div class="controls">
                <div class="controls-row">
                    <button class="btn btn-primary" onclick="showAddStudentModal()">
                        â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel()">
                        ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
                    </button>
                    <button class="btn btn-warning" onclick="document.getElementById('import-file').click()">
                        ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel
                    </button>
                    <input type="file" id="import-file" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(event)">
                    <button class="btn btn-danger" onclick="deleteAllStudents()" style="margin-right: 1rem;">
                        ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨
                    </button>                    
                </div>
                <div class="controls-row">
                    <select id="filter-grade" class="form-control" onchange="filterStudents()" style="max-width: 200px;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                        <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    </select>
                    <select id="filter-class" class="form-control" onchange="filterStudents()" style="max-width: 200px;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„ØµÙ</th>
                            <th>Ø§Ù„ÙØµÙ„</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th>
                            <th>Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
                            <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body">
                        <tr>
                            <td><span class="student-name" onclick="showStudentCard('ÙŠÙˆØ³Ù Ø£Ø­Ù…Ø¯ Ø±Ø§Ø¶ÙŠ Ø§Ù„ØªÙˆØ§ØªÙŠ')">ÙŠÙˆØ³Ù Ø£Ø­Ù…Ø¯ Ø±Ø§Ø¶ÙŠ Ø§Ù„ØªÙˆØ§ØªÙŠ</span></td>
                            <td>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</td>
                            <td>ÙØµÙ„ 1</td>
                            <td>2009/7/1</td>
                            <td>01005537722</td>
                            <td><span class="student-status pass">Ù†Ø§Ø¬Ø­</span></td>
                            <td>
                                <button class="btn btn-primary" onclick="editStudent('ÙŠÙˆØ³Ù Ø£Ø­Ù…Ø¯ Ø±Ø§Ø¶ÙŠ Ø§Ù„ØªÙˆØ§ØªÙŠ')" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                                    âœï¸ ØªØ¹Ø¯ÙŠÙ„
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content">
            <div class="controls">
                <div class="controls-row">
                    <button class="btn btn-success" onclick="markAllPresent()">
                        âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø­Ø§Ø¶Ø±
                    </button>
                    <button class="btn btn-danger" onclick="markAllAbsent()">
                        âŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…ÙŠØ¹ ØºØ§Ø¦Ø¨
                    </button>
                    <button class="btn btn-warning" onclick="saveAttendance()">
                        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±
                    </button>
                    <input type="date" id="attendance-date" class="form-control" style="max-width: 200px;" onchange="loadAttendanceForDate()">
                    <button class="btn btn-primary" onclick="printClassAttendance()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF Ù„Ù„ÙØµÙ„</button>
                    <button class="btn btn-success" onclick="printAnnualClassAttendance()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø³Ù†ÙˆÙŠ</button>
                    <button class="btn btn-warning" onclick="exportAnnualAttendance()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø³Ù†ÙˆÙŠ</button>
                    <button class="btn btn-primary" onclick="downloadDailyAttendancePDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
                </div>
                <div class="controls-row">
                    <select id="attendance-grade" class="form-control" onchange="filterAttendance()" style="max-width: 200px;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                        <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    </select>
                    <select id="attendance-class" class="form-control" onchange="filterAttendance()" style="max-width: 200px;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                    </select>
                    <button class="btn btn-primary" onclick="recordAllAttendance()">
                        ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø­ÙØ¸
                    </button>
                    <input type="month" id="attendance-month" class="form-control" style="max-width: 200px;">
                    <button class="btn btn-success" onclick="exportMonthlyAttendance()">ğŸ“¤ ØªØµØ¯ÙŠØ± ØºÙŠØ§Ø¨ Ø§Ù„Ø´Ù‡Ø±</button>
                </div>
            </div>

            <div class="stats-grid" style="margin: 2rem 0;">
                <div class="stat-card">
                    <div class="stat-card-icon">âœ…</div>
                    <div class="number" id="daily-present">1</div>
                    <div class="label">Ø­Ø§Ø¶Ø±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">âŒ</div>
                    <div class="number" id="daily-absent">0</div>
                    <div class="label">ØºØ§Ø¦Ø¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">ğŸ‘¥</div>
                    <div class="number" id="daily-total">1</div>
                    <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-icon">ğŸ“Š</div>
                    <div class="number" id="daily-percentage">100%</div>
                    <div class="label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                </div>
            </div>

            <h3 style="text-align: center; margin: 2rem 0;" id="attendance-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ØªØ§Ø±ÙŠØ® 2025/7/30</h3>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„ØµÙ</th>
                            <th>Ø§Ù„ÙØµÙ„</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table-body">
                        <tr>
                            <td>ÙŠÙˆØ³Ù Ø£Ø­Ù…Ø¯ Ø±Ø§Ø¶ÙŠ Ø§Ù„ØªÙˆØ§ØªÙŠ</td>
                            <td>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</td>
                            <td>ÙØµÙ„ 1</td>
                            <td><button class="btn btn-success" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">Ø­Ø§Ø¶Ø±</button></td>
                            <td>8:30 Øµ</td>
                            <td>
                                <button class="btn btn-success" onclick="toggleAttendance(this, 'present')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
                                    âœ…
                                </button>
                                <button class="btn btn-danger" onclick="toggleAttendance(this, 'absent')" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
                                    âŒ
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Grades Tab -->
        <div id="grades" class="tab-content">
            <div class="controls">
                <div class="controls-row">
                    <button class="btn btn-success" onclick="exportGradesSemester('semester1')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¯Ø±Ø¬Ø§Øª Ù1</button>
                    <button class="btn btn-warning" onclick="exportGradesSemester('semester2')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¯Ø±Ø¬Ø§Øª Ù2</button>
                    <select id="grades-grade" class="form-control" onchange="filterGrades()" style="max-width: 200px;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                        <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    </select>
                    <select id="grades-class" class="form-control" onchange="filterGrades()" style="max-width: 200px;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                    </select>
                    <select id="semester-select" class="form-control" onchange="updateGradesTable()" style="max-width: 200px;">
                        <option value="1">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£ÙˆÙ„</option>
                        <option value="2">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                    </select>
                </div>
                <div class="controls-row">
                    <button class="btn btn-warning" onclick="document.getElementById('import-grades-file').click()">
                        ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¯Ø±Ø¬Ø§Øª Ù…Ù† Excel
                    </button>
                    <input type="file" id="import-grades-file" accept=".xlsx,.xls" style="display: none;" onchange="importGradesFromExcel(event)">
                </div>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„ØµÙ</th>
                            <th>Ø§Ù„ÙØµÙ„</th>
                            <th>Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</th>
                            <th>Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</th>
                            <th>Ø§Ù„Ø¹Ù„ÙˆÙ…</th>
                            <th>Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</th>
                            <th>Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                            <th>Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="grades-table-body">
                        <tr>
                            <td>ÙŠÙˆØ³Ù Ø£Ø­Ù…Ø¯ Ø±Ø§Ø¶ÙŠ Ø§Ù„ØªÙˆØ§ØªÙŠ</td>
                            <td>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</td>
                            <td>ÙØµÙ„ 1</td>
                            <td><input type="number" class="form-control" placeholder="40" style="width: 80px; padding: 0.3rem;" onchange="calculateGrades(this)"></td>
                            <td><input type="number" class="form-control" placeholder="30" style="width: 80px; padding: 0.3rem;" onchange="calculateGrades(this)"></td>
                            <td><input type="number" class="form-control" placeholder="30" style="width: 80px; padding: 0.3rem;" onchange="calculateGrades(this)"></td>
                            <td><input type="number" class="form-control" placeholder="30" style="width: 80px; padding: 0.3rem;" onchange="calculateGrades(this)"></td>
                            <td><input type="number" class="form-control" placeholder="20" style="width: 80px; padding: 0.3rem;" onchange="calculateGrades(this)"></td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="controls">
                <div class="controls-row">
                    <select id="reports-grade" class="form-control" onchange="generateReports()" style="max-width: 200px;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                        <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    </select>
                    <select id="reports-class" class="form-control" onchange="generateReports()" style="max-width: 200px;">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                    </select>
                </div>
            </div>

            <div class="report-section">
                <div class="report-header">
                    <div class="report-icon">ğŸ†</div>
                    <div class="report-title">Ø£Ø¹Ù„Ù‰ 10 Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±</div>
                </div>
                <div id="top-attendance-report">
                    <div class="top-student">
                        <div class="student-rank gold">1</div>
                        <div style="flex: 1;">
                            <h4>ÙŠÙˆØ³Ù Ø£Ø­Ù…Ø¯ Ø±Ø§Ø¶ÙŠ Ø§Ù„ØªÙˆØ§ØªÙŠ</h4>
                            <p>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ - ÙØµÙ„ 1</p>
                        </div>
                        <div style="color: #4ecdc4; font-weight: bold; font-size: 1.2rem;">100%</div>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <div class="report-header">
                    <div class="report-icon">ğŸ’</div>
                    <div class="report-title">Ø£Ø¹Ù„Ù‰ 10 Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
                </div>
                <div id="top-grades-report">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’</div>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>
                    </div>
                </div>
            </div>

            <div class="report-section">
                <div class="report-header">
                    <div class="report-icon">âŒ</div>
                    <div class="report-title">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø±Ø§Ø³Ø¨ÙˆÙ†</div>
                </div>
                <div id="failed-students-report">
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø±Ø§Ø³Ø¨ÙˆÙ†</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Certificates Tab -->
        <div id="certificates" class="tab-content">
            <div class="controls">
                <div class="controls-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:</label>
                        <select id="cert-type" class="form-control" onchange="updateCertificateView()" style="max-width: 200px;">
                            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</option>
                            <option value="efada">Ø¥ÙØ§Ø¯Ø©</option>
                            <option value="bayan">Ø¨ÙŠØ§Ù† Ù†Ø¬Ø§Ø­</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Ø§Ù„ØµÙ:</label>
                        <select id="cert-grade" class="form-control" onchange="updateCertificateClasses()" style="max-width: 200px;">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                            <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                            <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                            <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Ø§Ù„ÙØµÙ„:</label>
                        <select id="cert-class" class="form-control" onchange="updateCertificateStudents()" style="max-width: 200px;">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                        <select id="cert-student" class="form-control" style="max-width: 250px;">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>
                        </select>
                    </div>
                </div>
                <div class="controls-row">
                    <button class="btn btn-primary" onclick="generateCertificate()">
                        ğŸ“„ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
                    </button>
                    <button class="btn btn-success" onclick="downloadCertificatePDF()">
                        ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF
                    </button>
                    <button class="btn btn-warning" onclick="previewCertificate()">
                        ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
                    </button>
                </div>
            </div>

            <div id="certificate-preview" style="display: none; margin-top: 2rem;">
                <!-- Ø¥ÙØ§Ø¯Ø© -->
                <div id="efada-template" class="certificate-container" style="display: none;">
                    <div class="certificate-quarter">
                        <div class="certificate-header">
                            <h2>Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… Ø¨ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</h2>
                            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø´Ø±Ù‚ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ® Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
                            <h3>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ø­Ù…Ø¯ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠØ© Ø¨Ù†ÙŠÙ†</h3>
                            <hr style="margin: 1rem 0; border: 1px solid #333;">
                            <h2 style="margin-top: 1rem;">Ø¥ÙØ§Ø¯Ø©</h2>
                        </div>
                        <div class="certificate-content">
                            <div class="certificate-row">
                                <span>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
                                <span id="efada-student-name"></span>
                            </div>
                            <div class="certificate-row">
                                <span>Ø§Ù„ØµÙ:</span>
                                <span id="efada-student-grade"></span>
                                <span>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</span>
                                <span id="efada-academic-year"></span>
                            </div>
                            <div class="certificate-row">
                                <span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</span>
                                <span id="efada-birth-date"></span>
                                <span>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ø±ÙŠØ±:</span>
                                <span id="efada-issue-date"></span>
                            </div>
                        </div>
                        <div class="certificate-footer">
                            <span>Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø¨Ø©</span>
                            <span>ÙŠØ¹ØªÙ…Ø¯ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</span>
                        </div>
                    </div>
                </div>

                <!-- Ø¨ÙŠØ§Ù† Ù†Ø¬Ø§Ø­ -->
                <div id="bayan-template" class="certificate-container" style="display: none;">
                    <div class="certificate-quarter">
                        <div class="certificate-header">
                            <h2>Ù…Ø­Ø§ÙØ¸Ø© ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</h2>
                            <h3>Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… Ø¨ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</h3>
                            <h3>Ø¥Ø¯Ø§Ø±Ø© Ø´Ø±Ù‚ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ® Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h3>
                            <h3>Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ø­Ù…Ø¯ÙŠ Ø§Ù„Ø§Ø¹Ø¯Ø§Ø¯ÙŠØ© Ø¨Ù†ÙŠÙ†</h3>
                            <hr style="margin: 1rem 0; border: 1px solid #333;">
                            <h2 style="margin-top: 1rem;">Ø¨ÙŠØ§Ù† Ù†Ø¬Ø§Ø­ Ø¨Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h2>
                        </div>
                        <div class="certificate-content">
                            <div class="certificate-row">
                                <span>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
                                <span id="bayan-student-name"></span>
                            </div>
                            <div class="certificate-row">
                                <span>Ù…Ù‚ÙŠØ¯ Ø¨Ø§Ù„ØµÙ:</span>
                                <span id="bayan-student-grade"></span>
                            </div>
                            <div class="certificate-row">
                                <span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</span>
                                <span id="bayan-birth-date"></span>
                            </div>
                            <div class="certificate-row">
                                <span>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</span>
                                <span id="bayan-academic-year"></span>
                            </div>
                            <div class="certificate-row" style="margin-top: 1rem;">
                                <span>Ù†Ø§Ø¬Ø­ ÙˆÙ…Ù†Ù‚ÙˆÙ„ Ù„Ù„ØµÙ:</span>
                                <span id="bayan-next-grade"></span>
                            </div>
                            <div style="margin-top: 1rem;">
                                <h3 style="margin-bottom: 0.5rem;">ÙˆÙ‚Ø¯ Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</h3>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                                    <tr>
                                        <th style="border: 1px solid #333; padding: 0.5rem;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                                        <th style="border: 1px solid #333; padding: 0.5rem;">Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø¸Ù…Ù‰</th>
                                        <th style="border: 1px solid #333; padding: 0.5rem;">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #333; padding: 0.5rem;">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-arabic-max"></td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-arabic-grade"></td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #333; padding: 0.5rem;">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-english-max"></td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-english-grade"></td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #333; padding: 0.5rem;">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-math-max"></td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-math-grade"></td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #333; padding: 0.5rem;">Ø§Ù„Ø¹Ù„ÙˆÙ…</td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-science-max"></td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-science-grade"></td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #333; padding: 0.5rem;">Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-social-max"></td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-social-grade"></td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #333; padding: 0.5rem;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-total-max"></td>
                                        <td style="border: 1px solid #333; padding: 0.5rem;" id="bayan-total-grade"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="certificate-footer" style="margin-top: 2rem;">
                            <div>
                                <span>Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø¨Ø©</span>
                                <br>
                                <span>ÙŠØ¹ØªÙ…Ø¯ØŒØŒ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</span>
                            </div>
                            <div style="text-align: center;">
                                <span>ØªØ­Ø±ÙŠØ±Ø§Ù‹ ÙÙŠ:</span>
                                <br>
                                <span id="bayan-issue-date"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="controls">
                <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h3>
                <div class="controls-row">
                    <div class="form-group">
                        <label>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
                        <input type="date" id="academic-start" class="form-control" value="2025-09-21">
                    </div>
                    <div class="form-group">
                        <label>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</label>
                        <input type="date" id="academic-end" class="form-control" value="2026-05-30">
                    </div>
                    <button class="btn btn-primary" onclick="saveAcademicYear()">
                        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                    </button>
                </div>
            </div>

            <div class="controls">
                <h3>Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„ØµÙ Ø§Ù„ØªØ§Ù„ÙŠ</h3>
                <div class="controls-row">
                    <p style="background: rgba(79, 172, 254, 0.1); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                        ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø§Ø¬Ø­ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„ØµÙ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡.
                    </p>
                    <select id="promotion-grade" class="form-control" style="max-width: 200px;">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                        <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    </select>
                    <button class="btn btn-success" onclick="promoteStudents()">
                        â¬†ï¸ Ù†Ù‚Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù†Ø§Ø¬Ø­ÙŠÙ†
                    </button>
                    <select id="move-student-select" class="form-control" style="max-width: 220px;"></select>
                    <select id="move-target-class" class="form-control" style="max-width: 160px;">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯</option>
                        <option value="1">ÙØµÙ„ 1</option>
                        <option value="2">ÙØµÙ„ 2</option>
                        <option value="3">ÙØµÙ„ 3</option>
                        <option value="4">ÙØµÙ„ 4</option>
                        <option value="5">ÙØµÙ„ 5</option>
                        <option value="6">ÙØµÙ„ 6</option>
                        <option value="7">ÙØµÙ„ 7</option>
                        <option value="8">ÙØµÙ„ 8</option>
                        <option value="9">ÙØµÙ„ 9</option>
                        <option value="10">ÙØµÙ„ 10</option>
                        <option value="11">ÙØµÙ„ 11</option>
                        <option value="12">ÙØµÙ„ 12</option>
                        <option value="13">ÙØµÙ„ 13</option>
                        <option value="14">ÙØµÙ„ 14</option>
                        <option value="15">ÙØµÙ„ 15</option>
                    </select>
                    <button class="btn btn-primary" onclick="moveStudentToClass()">â†”ï¸ Ù†Ù‚Ù„ Ø·Ø§Ù„Ø¨ Ù„ÙØµÙ„ Ø¢Ø®Ø±</button>
                </div>
            </div>

<div class="form-group">
    <h3>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
    <div class="controls-row">
        <button class="btn btn-primary" onclick="exportData()">
            ğŸ’¾ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
        <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">
            ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button class="btn btn-danger" onclick="clearAllData()">
            ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
    </div>
    <div style="background: rgba(255, 107, 107, 0.1); padding: 1rem; border-radius: 10px; margin-top: 1rem; border-right: 4px solid #ff6b6b;">
        <p><strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> ÙŠÙÙ†ØµØ­ Ø¨Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø­ Ø£Ùˆ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
    </div>
</div>
    </main>

    <!-- Footer -->
    <footer style="background: linear-gradient(135deg, #1a1d29 0%, #2d3142 100%); padding: 3rem 0 1rem; margin-top: 4rem; text-align: center; border-top: 3px solid #4facfe; position: relative;">
        <div class="container">
            <div style="color: var(--text-light); opacity: 0.9;">
                <div style="margin-bottom: 2rem;">
                    <h4 style="font-size: 1.3rem; margin-bottom: 1rem; color: #4facfe; font-weight: bold;">
                        Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨
                    </h4>
                    <p style="font-size: 1rem; margin-bottom: 0.5rem; opacity: 0.8;">
                        Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª
                    </p>
                </div>
                <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                    <p style="font-size: 0.9rem; margin: 0; color: rgba(255,255,255,0.6);">
                        Â© <span id="current-year"></span> Copyright Youssef Ellawaty - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Student Card Modal -->
    <div id="student-card-modal" class="modal" style="display: none;">
        <div class="modal-content student-card">
            <div class="modal-header">
                <h3 id="student-card-name">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                <span class="close-modal" onclick="closeStudentCard()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="student-info-grid">
                    <div class="info-section">
                        <h4>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h4>
                        <div class="info-row">
                            <span class="label">Ø§Ù„Ø§Ø³Ù…:</span>
                            <span id="card-student-name"></span>
                        </div>
                        <div class="info-row">
                           <span class="label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</span>
                           <span id="card-student-id"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Ø§Ù„ØµÙ:</span>
                            <span id="card-student-grade"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Ø§Ù„ÙØµÙ„:</span>
                            <span id="card-student-class"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</span>
                            <span id="card-student-birth"></span>
                        </div>
                        <div class="info-row">
                            <span class="label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ±:</span>
                            <span id="card-student-attendance"></span>
                        </div>
                    </div>
                </div>
                
                <div class="notes-section">
                    <h4>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h4>
                    <textarea id="card-student-notes" rows="3" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;"></textarea>
                    <button onclick="saveStudentNotes()" class="btn btn-primary" style="margin-top: 0.5rem;">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
                </div>
                
                <div class="card-actions">
                    <button onclick="editStudentFromCard()" class="btn btn-secondary">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button onclick="deleteStudentFromCard()" class="btn btn-danger">Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <form id="student-form">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                    <input type="text" id="student-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ:</label>
                    <input type="text" id="student-id" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
                    <input type="tel" id="student-phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</label>
                    <input type="tel" id="parent-phone" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØµÙ:</label>
                    <select id="student-grade" class="form-control" required onchange="updateClassOptions()">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                        <option value="1">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="2">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="3">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙØµÙ„:</label>
                    <select id="student-class" class="form-control" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</label>
                    <input type="date" id="student-birthdate" class="form-control" required>
                </div>
                <div class="controls-row">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage
        const storage = {
            saveData(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            },
            
            getData(key) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            }
        };

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let students = storage.getData('students') || [
            {
                name: 'ÙŠÙˆØ³Ù Ø£Ø­Ù…Ø¯ Ø±Ø§Ø¶ÙŠ Ø§Ù„ØªÙˆØ§ØªÙŠ',
                nationalId: '30507012301234',
                phone: '01123456789',
                parentPhone: '01005537722',
                grade: 1,
                class: 1,
                birthDate: '2009-07-01',
                gender: 'Ø°ÙƒØ±',
                attendance: {},
                grades: {
                    semester1: {
                        arabic: null,
                        math: null,
                        science: null,
                        english: null,
                        social: null
                    },
                    semester2: {
                        arabic: null,
                        math: null,
                        science: null,
                        english: null,
                        social: null
                    }
                },
                notes: '',
                status: 'active'
            }
        ];

        let settings = {
            academicStart: '2024-09-01',
            academicEnd: '2025-06-30',
            currentTheme: 'dark'
        };

        let attendanceData = {};
        let graduatedStudents = [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateDashboard();
            updateClassOptions();
            setCurrentDate();
            generateReports();
            // Autosave every 5 seconds
            window.__autosaveInterval = setInterval(saveData, 5000);
            // Set current year in footer
            document.getElementById('current-year').textContent = new Date().getFullYear();
        });

        // Data management
        function saveData() {
            localStorage.setItem('studentManagementData', JSON.stringify({
                students: students,
                settings: settings,
                attendanceData: attendanceData,
                graduatedStudents: graduatedStudents
            }));
        }

        // Ensure data persistence on unload
        window.addEventListener('beforeunload', function() {
            try { saveData(); } catch (e) {}
        });

        function loadData() {
            try {
                const savedData = localStorage.getItem('studentManagementData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    students = data.students || students;
                    attendanceData = data.attendanceData || attendanceData;
                    settings = data.settings || settings;
                    graduatedStudents = data.graduatedStudents || graduatedStudents;
                }
                updateDashboard();
                updateStudentsTable();
            } catch (err) {
                console.error('Error loading data:'  , err);
            }
        }
        
        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Update nav buttons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content based on tab
            if (tabName === 'students') {
                updateStudentsTable();
            } else if (tabName === 'attendance') {
                updateAttendanceTable();
            } else if (tabName === 'grades') {
                updateGradesTable();
            } else if (tabName === 'reports') {
                generateReports();
            }
        }

        // Dashboard functions
        function updateDashboard() {
            const grade1Count = students.filter(s => s.grade === 1 && s.status === 'active').length;
            const grade2Count = students.filter(s => s.grade === 2 && s.status === 'active').length;
            const grade3Count = students.filter(s => s.grade === 3 && s.status === 'active').length;
            const totalStudents = grade1Count + grade2Count + grade3Count;

            document.getElementById('grade1-count').textContent = grade1Count;
            document.getElementById('grade2-count').textContent = grade2Count;
            document.getElementById('grade3-count').textContent = grade3Count;
            document.getElementById('total-students').textContent = totalStudents;

            // Update attendance stats
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceData[today] || {};
            let presentCount = 0;
            let absentCount = 0;

            students.filter(s => s.status === 'active').forEach(student => {
                const state = todayAttendance[student.name];
                if (state === 'excused') {
                    // exclude from totals
                    return;
                } else if (state === 'absent') {
                    absentCount++;
                } else {
                    presentCount++; // Default to present
                }
            });

            document.getElementById('total-present').textContent = presentCount;
            document.getElementById('total-absent').textContent = absentCount;
            const effectiveTotal = totalStudents - Object.values(todayAttendance).filter(v => v === 'excused').length;
            const percentage = effectiveTotal > 0 ? Math.round((presentCount / effectiveTotal) * 100) : 100;
            document.getElementById('attendance-percentage').textContent = percentage + '%';
        }

// ...existing code...
function showClasses(grade) {
    const classesGrid = document.getElementById('classes-grid');
    const classesSection = document.getElementById('classes-section');
    
    classesGrid.innerHTML = '';
    // Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„ØµÙ
    const classCount = grade == 1 ? 15 : 12;
    for (let i = 1; i <= classCount; i++) {
        const classStudents = students.filter(s => s.grade === grade && s.class === i && s.status === 'active');
        const classCard = document.createElement('div');
        classCard.className = 'class-card';
        classCard.onclick = () => navigateToStudentsTab(grade, i);
        classCard.innerHTML = `
            <h4>ÙØµÙ„ ${i}</h4>
            <p>${classStudents.length} Ø·Ø§Ù„Ø¨</p>
        `;
        classesGrid.appendChild(classCard);
    }
    
    classesSection.style.display = 'block';
    classesGrid.classList.add('active');
}
// ...existing code...

        function navigateToStudentsTab(grade, classNum) {
            showTab('students');
            document.getElementById('filter-grade').value = grade;
            updateClassFilter();
            document.getElementById('filter-class').value = classNum;
            filterStudents();
        }

        // Student management
        function showAddStudentModal() {
            document.getElementById('modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('student-form').reset();
            document.getElementById('student-modal').classList.add('active');
        }

        function editStudent(studentName) {
            const student = students.find(s => s.name === studentName);
            if (!student) return;

            document.getElementById('modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨';
            document.getElementById('student-name').value = student.name;
            document.getElementById('student-id').value = student.nationalId;
            document.getElementById('student-phone').value = student.phone;
            document.getElementById('parent-phone').value = student.parentPhone;
            document.getElementById('student-grade').value = student.grade;
            updateClassOptions();
            document.getElementById('student-class').value = student.class;
            document.getElementById('student-birthdate').value = student.birthDate;
            document.getElementById('student-gender').value = student.gender;
            
            document.getElementById('student-modal').classList.add('active');
        }

        function deleteStudent(studentName) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                const index = students.findIndex(s => s.name === studentName);
                if (index > -1) {
                    students.splice(index, 1);
                    saveData();
                    updateDashboard();
                    updateStudentsTable();
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            }
        }

        function showStudentCard(studentName) {
            const student = students.find(s => s.name === studentName);
            if (!student) return;
            document.getElementById('card-student-id').textContent = student.nationalId;
            const totalDays = calculateTotalSchoolDays();
            const presentDays = calculateStudentAttendance(student.name);
            const attendancePercentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 100;

            const gradeNames = {
                arabic: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                math: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 
                science: 'Ø§Ù„Ø¹Ù„ÙˆÙ…',
                english: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
                social: 'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©'
            };

            const maxGrades = {
                arabic: 40,
                math: 30,
                science: 30,
                english: 30,
                social: 20
            };

            // Calculate semester 1 grades
            let totalGrades1 = 0;
            let totalMax1 = 0;
            let failedSubjects1 = [];
            
            // Calculate semester 2 grades
            let totalGrades2 = 0;
            let totalMax2 = 0;
            let failedSubjects2 = [];
            
            // Calculate total grades
            let totalGradesAll = 0;
            let totalMaxAll = 0;
            let failedSubjectsAll = [];
            
            let gradesHtml = '<h4>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø£ÙˆÙ„</h4><div class="grades-grid">';

            Object.keys(gradeNames).forEach(subject => {
                const grade1 = student.grades.semester1[subject] || 0;
                const grade2 = student.grades.semester2[subject] || 0;
                const totalGrade = grade1 + grade2;
                const maxGrade = maxGrades[subject];
                const isPassing1 = grade1 >= (maxGrade * 0.25);
                const isPassing2 = grade2 >= (maxGrade * 0.25);
                const isPassingTotal = totalGrade >= (maxGrade * 0.5);
                
                if (grade1 > 0) {
                    totalGrades1 += grade1;
                    totalMax1 += maxGrade / 2;
                    if (!isPassing1) {
                        failedSubjects1.push(gradeNames[subject]);
                    }
                }
                
                if (grade2 > 0) {
                    totalGrades2 += grade2;
                    totalMax2 += maxGrade / 2;
                    if (!isPassing2) {
                        failedSubjects2.push(gradeNames[subject]);
                    }
                }
                
                if (totalGrade > 0) {
                    totalGradesAll += totalGrade;
                    totalMaxAll += maxGrade;
                    if (!isPassingTotal) {
                        failedSubjectsAll.push(gradeNames[subject]);
                    }
                }

                gradesHtml += `
                    <div class="grade-item ${isPassing1 ? 'pass' : 'fail'}">
                        <h5>${gradeNames[subject]}</h5>
                        <div class="grade">${grade1 || '-'}/${maxGrade/2}</div>
                        <input type="number" class="form-control" style="margin-top: 0.5rem; font-size: 0.8rem;" 
                               value="${grade1 || ''}" max="${maxGrade/2}" 
                               onchange="updateStudentGrade('${student.name}', 'semester1', '${subject}', this.value)">
                    </div>
                `;
            });

            gradesHtml += '</div><h4>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠ</h4><div class="grades-grid">';

            Object.keys(gradeNames).forEach(subject => {
                const grade2 = student.grades.semester2[subject] || 0;
                const maxGrade = maxGrades[subject];
                const isPassing2 = grade2 >= (maxGrade * 0.25);

                gradesHtml += `
                    <div class="grade-item ${isPassing2 ? 'pass' : 'fail'}">
                        <h5>${gradeNames[subject]}</h5>
                        <div class="grade">${grade2 || '-'}/${maxGrade/2}</div>
                        <input type="number" class="form-control" style="margin-top: 0.5rem; font-size: 0.8rem;" 
                               value="${grade2 || ''}" max="${maxGrade/2}" 
                               onchange="updateStudentGrade('${student.name}', 'semester2', '${subject}', this.value)">
                    </div>
                `;
            });

            gradesHtml += '</div>';

            const percentage1 = totalMax1 > 0 ? Math.round((totalGrades1 / totalMax1) * 100) : 0;
            const percentage2 = totalMax2 > 0 ? Math.round((totalGrades2 / totalMax2) * 100) : 0;
            const percentageAll = totalMaxAll > 0 ? Math.round((totalGradesAll / totalMaxAll) * 100) : 0;
            const isPassing = failedSubjectsAll.length === 0 && percentageAll >= 50;

            const cardContent = `
                <div class="student-card">
                    <div class="student-info-grid">
                        <div class="info-item">
                            <h4>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</h4>
                            <p>${student.name}</p>
                        </div>
                        <div class="info-item">
                            <h4>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</h4>
                            <p>${student.nationalId}</p>
                        </div>
                        <div class="info-item">
                            <h4>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</h4>
                            <p>${student.phone}</p>
                        </div>
                        <div class="info-item">
                            <h4>Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h4>
                            <p>${student.parentPhone}</p>
                        </div>
                        <div class="info-item">
                            <h4>Ø§Ù„ØµÙ ÙˆØ§Ù„ÙØµÙ„</h4>
                            <p>Ø§Ù„ØµÙ ${getGradeName(student.grade)} - ÙØµÙ„ ${student.class}</p>
                        </div>
                        <div class="info-item">
                            <h4>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</h4>
                            <p>${(student.birthDate || '').replace(/-/g, '/')}</p>
                        </div>
                    </div>

                    <div class="attendance-summary">
                        <div class="attendance-percentage">${attendancePercentage}%</div>
                        <p>Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (${presentDays} Ù…Ù† ${totalDays} ÙŠÙˆÙ…)</p>
                    </div>

                    <h3 style="text-align: center; margin: 2rem 0;">Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
                    <div class="grades-grid">
                        ${gradesHtml}
                    </div>

                    <div style="text-align: center; margin: 2rem 0;">
                        <div class="student-status ${isPassing ? 'pass' : 'fail'}">
                            ${isPassing ? 'Ù†Ø§Ø¬Ø­' : 'Ø±Ø§Ø³Ø¨'}
                        </div>
                        ${totalMaxAll > 0 ? `
                            <p>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„: ${totalGrades1}/${totalMax1} (${percentage1}%)</p>
                            <p>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ: ${totalGrades2}/${totalMax2} (${percentage2}%)</p>
                            <p>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${totalGradesAll}/${totalMaxAll} (${percentageAll}%)</p>
                        ` : ''}
                    </div>

                    ${failedSubjectsAll.length > 0 ? `
                        <div class="failed-subjects">
                            <h4>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø±Ø§Ø³Ø¨ Ø¨Ù‡Ø§:</h4>
                            <p>${failedSubjectsAll.join('ØŒ ')}</p>
                        </div>
                    ` : ''}

                    <div class="notes-section">
                        <h4>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h4>
                        <textarea placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..." 
                                  onchange="updateStudentNotes('${student.name}', this.value)">${student.notes || ''}</textarea>
                    </div>

                    <div class="controls-row" style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="editStudent('${student.name}')">
                            âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </button>
                        <button class="btn btn-warning" onclick="promoteStudent('${student.name}')">
                            â¬†ï¸ Ù†Ù‚Ù„ Ù„Ù„ØµÙ Ø§Ù„ØªØ§Ù„ÙŠ
                        </button>
                        <button class="btn btn-danger" onclick="deleteStudentFromCard('${student.name}')">
                            ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('student-card-content').innerHTML = cardContent;
            document.getElementById('student-card-modal').classList.add('active');
        }

        function updateStudentGrade(studentName, semester, subject, value) {
            const student = students.find(s => s.name === studentName);
            if (student) {
                if (semester === 'semester1' || semester === 'semester2') {
                    student.grades[semester][subject] = value ? parseInt(value) : null;
                } else {
                    // Backward compatibility
                    student.grades.semester1[subject] = value ? parseInt(value) : null;
                }
                saveData();
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        function updateStudentNotes(studentName, notes) {
            const student = students.find(s => s.name === studentName);
            if (student) {
                student.notes = notes;
                saveData();
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        function promoteStudent(studentName) {
            const student = students.find(s => s.name === studentName);
            if (!student) return;

            if (student.grade >= 3) {
                if (confirm('Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ®Ø±Ø¬ÙŠÙ†ØŸ')) {
                    student.status = 'graduated';
                    graduatedStudents.push({
                        ...student,
                        graduationDate: new Date().toISOString().split('T')[0]
                    });
                    saveData();
                    updateDashboard();
                    updateStudentsTable();
                    closeStudentCard();
                    showToast('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ®Ø±Ø¬ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­', 'success');
                }
            } else {
                if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ ${getGradeName(student.grade + 1)}ØŸ`)) {
                    student.grade += 1;
                    student.class = 1; // Reset to first class in new grade
                    // Reset all grades for the new academic year
                    student.grades = {
                        semester1: { arabic: null, math: null, science: null, english: null, social: null },
                        semester2: { arabic: null, math: null, science: null, english: null, social: null }
                    };
                    saveData();
                    updateDashboard();
                    updateStudentsTable();
                    showStudentCard(studentName); // Refresh the card
                    showToast('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„Ù„Ø³Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', 'success');
                }
            }
        }

        function deleteStudentFromCard(studentName) {
            closeStudentCard();
            deleteStudent(studentName);
        }

        function closeModal() {
            document.getElementById('student-modal').classList.remove('active');
        }

        function closeStudentCard() {
            document.getElementById('student-card-modal').classList.remove('active');
        }

        // Form submission
        document.getElementById('student-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('student-name').value,
                nationalId: document.getElementById('student-id').value,
                phone: document.getElementById('student-phone').value,
                parentPhone: document.getElementById('parent-phone').value,
                grade: parseInt(document.getElementById('student-grade').value),
                class: parseInt(document.getElementById('student-class').value),
                birthDate: document.getElementById('student-birthdate').value,
                gender: document.getElementById('student-gender').value,
                attendance: {},
                grades: {
                    semester1: {
                        arabic: null,
                        math: null,
                        science: null,
                        english: null,
                        social: null
                    },
                    semester2: {
                        arabic: null,
                        math: null,
                        science: null,
                        english: null,
                        social: null
                    }
                },
                notes: '',
                status: 'active'
            };

            // Check if editing existing student
            const existingIndex = students.findIndex(s => s.name === formData.name);
            if (existingIndex > -1) {
                // Keep attendance and grades data
                formData.attendance = students[existingIndex].attendance;
                formData.grades = students[existingIndex].grades || {
                    semester1: { arabic: null, math: null, science: null, english: null, social: null },
                    semester2: { arabic: null, math: null, science: null, english: null, social: null }
                };
                formData.notes = students[existingIndex].notes;
                students[existingIndex] = formData;
            } else {
                students.push(formData);
            }

            saveData();
            updateDashboard();
            updateStudentsTable();
            closeModal();
            showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        });

        // Update class options based on selected grade
function updateClassOptions() {
    const gradeSelect = document.getElementById('student-grade');
    const classSelect = document.getElementById('student-class');
    
    classSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>';
    if (gradeSelect.value) {
        // Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„ØµÙ
        const classCount = gradeSelect.value == 1 ? 15 : 12;
        for (let i = 1; i <= classCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `ÙØµÙ„ ${i}`;
            classSelect.appendChild(option);
        }
    }
}

function updateClassFilter() {
    const gradeSelect = document.getElementById('filter-grade');
    const classSelect = document.getElementById('filter-class');
    
    classSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>';
    if (gradeSelect.value) {
        // Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„ØµÙ
        const classCount = gradeSelect.value == 1 ? 15 : 12;
        for (let i = 1; i <= classCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `ÙØµÙ„ ${i}`;
            classSelect.appendChild(option);
        }
    }
}

        // Update students table
        function updateStudentsTable() {
            const tbody = document.getElementById('students-table-body');
            const filteredStudents = getFilteredStudents();
            
            tbody.innerHTML = filteredStudents.map(student => {
            const totalDays = calculateTotalSchoolDays() - calculateStudentExcusedDaysInAcademicYear(student.name);
            const presentDays = calculateStudentPresentDaysInAcademicYear(student.name);
                const attendancePercentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 100;
                
                // Calculate student status with new grade structure
                let totalGrades = 0;
                let totalMax = 0;
                let failedSubjects = 0;
                let hasAnyGrade = false;
                const maxGrades = { arabic: 80, math: 60, science: 40, english: 60, social: 40 };
                
                Object.keys(maxGrades).forEach(subject => {
                    const raw1 = student.grades.semester1?.[subject];
                    const raw2 = student.grades.semester2?.[subject];
                    const grade1 = raw1 || 0;
                    const grade2 = raw2 || 0;
                    const totalGrade = grade1 + grade2;
                    const maxGrade = maxGrades[subject];
                    if (raw1 != null || raw2 != null) {
                        hasAnyGrade = true;
                    }
                    if (totalGrade > 0) {
                        totalGrades += totalGrade;
                        totalMax += maxGrade;
                        if (totalGrade < (maxGrade * 0.5)) {
                            failedSubjects++;
                        }
                    }
                });
                
                const percentage = totalMax > 0 ? Math.round((totalGrades / totalMax) * 100) : 0;
                const isPassing = hasAnyGrade && failedSubjects === 0 && (totalMax === 0 || percentage >= 50);
                const statusLabel = hasAnyGrade ? (isPassing ? 'Ù†Ø§Ø¬Ø­' : 'Ø±Ø§Ø³Ø¨') : 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø¬Ø§Øª';
                const statusClass = hasAnyGrade ? (isPassing ? 'pass' : 'fail') : 'pending';
                
                return `
                    <tr>
                        <td><a href="#" class="student-link" onclick="showStudentCard('${student.name}')">${student.name}</a></td>
                        <td>${getGradeName(student.grade)}</td>
                        <td>ÙØµÙ„ ${student.class}</td>
                        <td>${(student.birthDate || '').replace(/-/g, '/')}</td>
                        <td>${student.parentPhone}</td>
                        <td>${student.nationalId}</td>
                       <td>
                           <button class="btn btn-primary" onclick="editStudent('${student.name}')" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                           âœï¸ ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button class="btn btn-danger" onclick="deleteStudent('${student.name}')" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                        ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                        </td>
                        </tr>
                `;
            }).join('');
        }
        

        function getFilteredStudents() {
            const gradeFilter = document.getElementById('filter-grade')?.value;
            const classFilter = document.getElementById('filter-class')?.value;
            
            return students.filter(student => {
                if (student.status !== 'active') return false;
                if (gradeFilter && student.grade != gradeFilter) return false;
                if (classFilter && student.class != classFilter) return false;
                return true;
            }).sort((a, b) => a.name.localeCompare(b.name, 'ar'));
        }

        function filterStudents() {
            updateStudentsTable();
        }

        // Attendance functions
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendance-date').value = today;
            loadAttendanceForDate();
        }

        function loadAttendanceForDate() {
            const date = document.getElementById('attendance-date').value;
            updateAttendanceTable();
            updateAttendanceTitle(date);
        }

        function updateAttendanceTitle(date) {
            const formattedDate = new Date(date).toLocaleDateString('ar-EG');
            document.getElementById('attendance-title').textContent = `Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ØªØ§Ø±ÙŠØ® ${formattedDate}`;
        }

        function updateAttendanceTable() {
            const tbody = document.getElementById('attendance-table-body');
            const date = document.getElementById('attendance-date').value;
            // Enforce date within academic year
            const start = new Date(settings.academicStart).toISOString().split('T')[0];
            const endAcademic = new Date(settings.academicEnd).toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            if (date < start || date > endAcademic) {
                document.getElementById('attendance-title').textContent = 'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯';
                tbody.innerHTML = '';
                document.getElementById('daily-present').textContent = 0;
                document.getElementById('daily-absent').textContent = 0;
                document.getElementById('daily-total').textContent = 0;
                document.getElementById('daily-percentage').textContent = '0%';
                return;
            }
            if (date > today) {
                document.getElementById('attendance-title').textContent = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ ØªØ§Ø±ÙŠØ® Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ';
                tbody.innerHTML = '';
                document.getElementById('daily-present').textContent = 0;
                document.getElementById('daily-absent').textContent = 0;
                document.getElementById('daily-total').textContent = 0;
                document.getElementById('daily-percentage').textContent = '0%';
                return;
            }
            const filteredStudents = getFilteredAttendanceStudents();
            
            let presentCount = 0;
            let absentCount = 0;
            let excusedCount = 0;
            
            tbody.innerHTML = filteredStudents.map(student => {
                const attendance = attendanceData[date]?.[student.name];
                const isExcused = attendance === 'excused';
                const isPresent = attendance === 'present' || attendance === undefined;
                if (isExcused) {
                    excusedCount++;
                } else if (isPresent) {
                    presentCount++;
                } else {
                    absentCount++;
                }
                
                return `
                    <tr data-student="${student.name}">
                        <td><a href="#" class="student-link" onclick="showStudentCard('${student.name}')">${student.name}</a></td>
                        <td>${getGradeName(student.grade)}</td>
                        <td>ÙØµÙ„ ${student.class}</td>
                        <td>
                            <button class="btn ${isExcused ? 'btn-warning' : (isPresent ? 'btn-success' : 'btn-danger')}" 
                                    style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                                ${isExcused ? 'ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±' : (isPresent ? 'Ø­Ø§Ø¶Ø±' : 'ØºØ§Ø¦Ø¨')}
                            </button>
                        </td>
                        <td>${isPresent ? '8:30 Øµ' : '-'}</td>
                        <td>
                            <button class="btn btn-success" onclick="toggleAttendance(this, 'present')" 
                                    style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
                                âœ…
                            </button>
                            <button class="btn btn-danger" onclick="toggleAttendance(this, 'absent')" 
                                    style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
                                âŒ
                            </button>
                            <button class="btn btn-warning" onclick="toggleAttendance(this, 'excused')" 
                                    style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">
                                ğŸ“
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update daily stats
            const effectiveTotal = filteredStudents.length - excusedCount;
            document.getElementById('daily-present').textContent = presentCount;
            document.getElementById('daily-absent').textContent = absentCount;
            document.getElementById('daily-total').textContent = effectiveTotal;
            const percentage = effectiveTotal > 0 ? Math.round((presentCount / effectiveTotal) * 100) : 100;
            document.getElementById('daily-percentage').textContent = percentage + '%';
        }

        function getFilteredAttendanceStudents() {
            const gradeFilter = document.getElementById('attendance-grade')?.value;
            const classFilter = document.getElementById('attendance-class')?.value;
            
            return students.filter(student => {
                if (student.status !== 'active') return false;
                if (gradeFilter && student.grade != gradeFilter) return false;
                if (classFilter && student.class != classFilter) return false;
                return true;
            }).sort((a, b) => a.name.localeCompare(b.name, 'ar'));
        }

        function filterAttendance() {
            updateAttendanceTable();
        }

        function markAllPresent() {
            const date = document.getElementById('attendance-date').value;
            const filteredStudents = getFilteredAttendanceStudents();
            
            if (!attendanceData[date]) {
                attendanceData[date] = {};
            }
            
            filteredStudents.forEach(student => {
                attendanceData[date][student.name] = 'present';
            });
            
            saveData();
            updateAttendanceTable();
            showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙƒØ­Ø§Ø¶Ø±ÙŠÙ†', 'success');
        }

        function markAllAbsent() {
            const date = document.getElementById('attendance-date').value;
            const filteredStudents = getFilteredAttendanceStudents();
            
            if (!attendanceData[date]) {
                attendanceData[date] = {};
            }
            
            filteredStudents.forEach(student => {
                attendanceData[date][student.name] = 'absent';
            });
            
            saveData();
            updateAttendanceTable();
            showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙƒØºØ§Ø¦Ø¨ÙŠÙ†', 'warning');
        }

        function toggleAttendance(button, status) {
            const row = button.closest('tr');
            const studentName = row.dataset.student;
            const date = document.getElementById('attendance-date').value;
            
            if (!attendanceData[date]) {
                attendanceData[date] = {};
            }
            
            attendanceData[date][studentName] = status;
            saveData();
            updateAttendanceTable();
            updateDashboard();
        }

        function saveAttendance() {
            saveData();
            showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function recordAllAttendance() {
            saveAttendance();
        }

        // Print attendance per selected class as PDF (use browser print -> Save as PDF)
        function printClassAttendance() {
            const grade = document.getElementById('attendance-grade').value;
            const classNum = document.getElementById('attendance-class').value;
            if (!grade || !classNum) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            // Open print dialog; print styles will limit to attendance table
            window.print();
        }

        // Build and print annual attendance table (Sun-Thu across academic year)
        function printAnnualClassAttendance() {
            const grade = document.getElementById('attendance-grade').value;
            const classNum = document.getElementById('attendance-class').value;
            if (!grade || !classNum) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            const studentsList = students.filter(s => s.status === 'active' && s.grade == grade && s.class == classNum);

            // Create a printable window
            const win = window.open('', '_blank');
            const title = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø³Ù†ÙˆÙŠ - ${getGradeName(parseInt(grade))} - ÙØµÙ„ ${classNum}`;
            let html = `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>${title}</title>
                <style>body{font-family:'Cairo',Tahoma;}
                table{border-collapse:collapse;width:100%;}
                th,td{border:1px solid #000;padding:4px;text-align:center;}
                th{background:#eee;}
                </style></head><body>`;
            html += `<h2>${title}</h2>`;
            html += `<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr></thead><tbody>`;

            const totalDays = calculateTotalSchoolDays();
            studentsList.forEach(st => {
                const present = calculateStudentPresentDaysInAcademicYear(st.name);
                const pct = totalDays > 0 ? Math.round((present/totalDays)*100) : 100;
                html += `<tr><td>${st.name}</td><td>${present}</td><td>${pct}%</td></tr>`;
            });
            html += `</tbody></table></body></html>`;
            win.document.write(html);
            win.document.close();
            win.focus();
            win.print();
        }

        // Export annual attendance for current academic year only
        function exportAnnualAttendance() {
            const grade = document.getElementById('attendance-grade').value;
            const classNum = document.getElementById('attendance-class').value;
            if (!grade || !classNum) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ ÙˆØ§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            const studentNames = students
                .filter(s => s.status === 'active' && s.grade == grade && s.class == classNum)
                .map(s => s.name);
            if (studentNames.length === 0) {
                showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„', 'warning');
                return;
            }
            const start = new Date(settings.academicStart);
            const endCap = new Date(settings.academicEnd);
            const today = new Date();
            const end = endCap < today ? endCap : today;

            const header = ['Ø§Ù„ØªØ§Ø±ÙŠØ®', ...studentNames];
            const rows = [];
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dow = d.getDay();
                if (dow < 0 || dow > 4) continue; // Sun-Thu only
                const iso = d.toISOString().split('T')[0];
                const row = { 'Ø§Ù„ØªØ§Ø±ÙŠØ®': iso };
                studentNames.forEach(name => {
                    const state = attendanceData[iso]?.[name];
                    row[name] = state === 'absent' ? 'ØºØ§Ø¦Ø¨' : (state === 'excused' ? 'ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±' : 'Ø­Ø§Ø¶Ø±');
                });
                rows.push(row);
            }

            if (rows.length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠØ§Ù… Ø¯Ø±Ø§Ø³Ø© Ø¶Ù…Ù† Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯', 'warning');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(rows, { header });
            const cols = header.map((h, idx) => ({ wch: idx === 0 ? 12 : 20 }));
            ws['!cols'] = cols;
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ØºÙŠØ§Ø¨_Ø§Ù„Ø¹Ø§Ù…');
            XLSX.writeFile(wb, `ØºÙŠØ§Ø¨_Ø³Ù†ÙˆÙŠ_${getGradeName(parseInt(grade))}_ÙØµÙ„_${classNum}.xlsx`);
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ø³Ù†ÙˆÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // Export monthly attendance for selected class as Excel
        function exportMonthlyAttendance() {
            const grade = document.getElementById('attendance-grade').value;
            const classNum = document.getElementById('attendance-class').value;
            const monthVal = document.getElementById('attendance-month').value; // YYYY-MM
            if (!grade || !classNum || !monthVal) {
                showToast('Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø´Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            const [year, month] = monthVal.split('-').map(n => parseInt(n));
            const start = new Date(year, month - 1, 1);
            const end = new Date(year, month, 0);
            const targetStudents = students
                .filter(s => s.status === 'active' && s.grade == grade && s.class == classNum)
                .map(s => s.name);

            if (targetStudents.length === 0) {
                showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„', 'warning');
                return;
            }

            // Build pivot: header = ['Ø§Ù„ØªØ§Ø±ÙŠØ®', ...studentNames]
            const header = ['Ø§Ù„ØªØ§Ø±ÙŠØ®', ...targetStudents];
            const rows = [];

            const yearStart = new Date(settings.academicStart);
            const yearEnd = new Date(settings.academicEnd);
            const today = new Date();
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dow = d.getDay();
                if (d < yearStart || d > yearEnd) continue; // outside academic year
                if (d > today) continue; // skip future
                if (dow < 0 || dow > 4) continue; // Sun-Thu only
                const iso = d.toISOString().split('T')[0];
                const row = { 'Ø§Ù„ØªØ§Ø±ÙŠØ®': iso };
                targetStudents.forEach(name => {
                    const state = attendanceData[iso]?.[name];
                    row[name] = state === 'absent' ? 'ØºØ§Ø¦Ø¨' : (state === 'excused' ? 'ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±' : 'Ø­Ø§Ø¶Ø±');
                });
                rows.push(row);
            }

            if (rows.length === 0) {
                showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠØ§Ù… Ø¯Ø±Ø§Ø³Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±', 'warning');
                return;
            }

            // Create worksheet with custom header order and column widths
            const ws = XLSX.utils.json_to_sheet(rows, { header });
            // Column widths: date wider, names also wide for Arabic
            const cols = header.map((h, idx) => ({ wch: idx === 0 ? 12 : 20 }));
            ws['!cols'] = cols;
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ØºÙŠØ§Ø¨_Ø§Ù„Ø´Ù‡Ø±');
            XLSX.writeFile(wb, `ØºÙŠØ§Ø¨_${getGradeName(parseInt(grade))}_ÙØµÙ„_${classNum}_${monthVal}.xlsx`);
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± ØºÙŠØ§Ø¨ Ø§Ù„Ø´Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // Grades functions
        function updateGradesTable() {
            const tbody = document.getElementById('grades-table-body');
            const filteredStudents = getFilteredGradesStudents();
            const semester = document.getElementById('semester-select').value;
            
            tbody.innerHTML = filteredStudents.map(student => {
                const maxGrades = { arabic: 80, math: 60, science: 40, english: 60, social: 40 };
                
                let totalGrades = 0;
                let totalMax = 0;
                let failedSubjects = 0;
                let gradesData = {};
                let hasAnyGrade = false;
                
                if (semester === 'total') {
                    // Show combined grades from both semesters
                    Object.keys(maxGrades).forEach(subject => {
                        const raw1 = student.grades.semester1?.[subject];
                        const raw2 = student.grades.semester2?.[subject];
                        const grade1 = raw1 || 0;
                        const grade2 = raw2 || 0;
                        const totalGrade = grade1 + grade2;
                        const maxGrade = maxGrades[subject];
                        gradesData[subject] = totalGrade;
                        if (raw1 != null || raw2 != null) hasAnyGrade = true;
                        if (totalGrade > 0) {
                            totalGrades += totalGrade;
                            totalMax += maxGrade;
                            if (totalGrade < (maxGrade * 0.5)) {
                                failedSubjects++;
                            }
                        }
                    });
                } else {
                    // Show specific semester grades
                    const semesterGrades = student.grades[semester] || {};
                    Object.keys(maxGrades).forEach(subject => {
                        const raw = semesterGrades[subject];
                        const grade = raw || 0;
                        const maxGrade = maxGrades[subject] / 2; // Half for each semester
                        gradesData[subject] = grade;
                        if (raw != null) hasAnyGrade = true;
                        if (grade > 0) {
                            totalGrades += grade;
                            totalMax += maxGrade;
                            if (grade < (maxGrade * 0.5)) {
                                failedSubjects++;
                            }
                        }
                    });
                }
                
                const percentage = totalMax > 0 ? Math.round((totalGrades / totalMax) * 100) : 0;
                const isPassing = hasAnyGrade && failedSubjects === 0 && (totalMax === 0 || percentage >= 50);
                const statusLabel = hasAnyGrade ? (isPassing ? 'Ù†Ø§Ø¬Ø­' : 'Ø±Ø§Ø³Ø¨') : 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø¬Ø§Øª';
                const statusClass = hasAnyGrade ? (isPassing ? 'pass' : 'fail') : 'pending';
                
                // ...Ø¯Ø§Ø®Ù„ tbody.innerHTML = filteredStudents.map(student => { ... })...
return `
    <tr data-student="${student.name}">
        <td><a href="#" onclick="showStudentCard('${student.name}')" style="color: #007bff; text-decoration: none;">${student.name}</a></td>
        <td>${getGradeName(student.grade)}</td>
        <td>ÙØµÙ„ ${student.class}</td>
        <td><input type="number" class="form-control" placeholder="0-${semester === 'total' ? 80 : 40}" max="${semester === 'total' ? 80 : 40}" value="${gradesData.arabic || ''}" style="width: 80px; padding: 0.3rem;" onchange="updateGrade('${student.name}', '${semester}', 'arabic', this.value)" ${semester === 'total' ? 'readonly' : ''}></td>
        <td><input type="number" class="form-control" placeholder="0-${semester === 'total' ? 60 : 30}" max="${semester === 'total' ? 60 : 30}" value="${gradesData.math || ''}" style="width: 80px; padding: 0.3rem;" onchange="updateGrade('${student.name}', '${semester}', 'math', this.value)" ${semester === 'total' ? 'readonly' : ''}></td>
        <td><input type="number" class="form-control" placeholder="0-${semester === 'total' ? 40 : 20}" max="${semester === 'total' ? 40 : 20}" value="${gradesData.science || ''}" style="width: 80px; padding: 0.3rem;" onchange="updateGrade('${student.name}', '${semester}', 'science', this.value)" ${semester === 'total' ? 'readonly' : ''}></td>
        <td><input type="number" class="form-control" placeholder="0-${semester === 'total' ? 60 : 30}" max="${semester === 'total' ? 60 : 30}" value="${gradesData.english || ''}" style="width: 80px; padding: 0.3rem;" onchange="updateGrade('${student.name}', '${semester}', 'english', this.value)" ${semester === 'total' ? 'readonly' : ''}></td>
        <td><input type="number" class="form-control" placeholder="0-${semester === 'total' ? 40 : 20}" max="${semester === 'total' ? 40 : 20}" value="${gradesData.social || ''}" style="width: 80px; padding: 0.3rem;" onchange="updateGrade('${student.name}', '${semester}', 'social', this.value)" ${semester === 'total' ? 'readonly' : ''}></td>
        <td>${semester === 'total' && totalMax > 0 ? totalGrades : (totalMax > 0 ? totalGrades : '-')}</td>
        <td>${totalMax > 0 ? percentage + '%' : '-'}</td>
        <td>${student.nationalId}</td>
    </tr>
`;
// ...existing code...
            }).join('');
        }

        function getFilteredGradesStudents() {
            const gradeFilter = document.getElementById('grades-grade')?.value;
            const classFilter = document.getElementById('grades-class')?.value;
            
            return students.filter(student => {
                if (student.status !== 'active') return false;
                if (gradeFilter && student.grade != gradeFilter) return false;
                if (classFilter && student.class != classFilter) return false;
                return true;
            }).sort((a, b) => a.name.localeCompare(b.name, 'ar'));
        }

        function filterGrades() {
            updateGradesTable();
        }

        function updateGrade(studentName, semester, subject, value) {
            const maxGrades = { arabic: 40, math: 30, science: 20, english: 30, social: 20 };
            const numValue = parseInt(value);
            
            // Check maximum grade limits for each semester
            if (numValue > maxGrades[subject]) {
                showToast(`Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ Ù„Ù…Ø§Ø¯Ø© ${getSubjectName(subject)} ÙÙŠ Ø§Ù„ÙØµÙ„ Ø§Ù„ÙˆØ§Ø­Ø¯ Ù‡ÙŠ ${maxGrades[subject]}`, 'error');
                updateGradesTable(); // Reset the display
                return;
            }
            
            const student = students.find(s => s.name === studentName);
            if (student && semester !== 'total') {
                if (!student.grades[semester]) {
                    student.grades[semester] = { arabic: null, math: null, science: null, english: null, social: null };
                }
                student.grades[semester][subject] = value ? numValue : null;
                saveData();
                updateGradesTable();
            }
        }
        
        function getSubjectName(subject) {
            const names = {
                arabic: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                math: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
                science: 'Ø§Ù„Ø¹Ù„ÙˆÙ…',
                english: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
                social: 'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©'
            };
            return names[subject] || subject;
        }

        function calculateGrades(input) {
            const row = input.closest('tr');
            updateGradesTable();
        }

        function addGradesForAll() {
            showToast('ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø¹Ù„Ø§Ù‡', 'info');
        }

        function exportGrades() {
            const filteredStudents = getFilteredGradesStudents();
            const data = filteredStudents.map(student => {
                const maxGrades = { arabic: 40, math: 30, science: 30, english: 30, social: 20 };
                
                let totalGrades = 0;
                let totalMax = 0;
                let semester1Total = 0;
                let semester2Total = 0;
                
                Object.keys(maxGrades).forEach(subject => {
                    const grade1 = student.grades.semester1?.[subject] || 0;
                    const grade2 = student.grades.semester2?.[subject] || 0;
                    const totalGrade = grade1 + grade2;
                    const maxGrade = maxGrades[subject];
                    if (totalGrade > 0) {
                        totalGrades += totalGrade;
                        totalMax += maxGrade;
                    }
                    semester1Total += grade1;
                    semester2Total += grade2;
                });
                
                const percentage = totalMax > 0 ? Math.round((totalGrades / totalMax) * 100) : 0;
                
                return {
                    'Ø§Ù„Ø§Ø³Ù…': student.name,
                    'Ø§Ù„ØµÙ': getGradeName(student.grade),
                    'Ø§Ù„ÙØµÙ„': `ÙØµÙ„ ${student.class}`,
                    'Ø¹Ø±Ø¨ÙŠ Ù1': student.grades.semester1?.arabic || 0,
                    'Ø¹Ø±Ø¨ÙŠ Ù2': student.grades.semester2?.arabic || 0,
                    'Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù1': student.grades.semester1?.math || 0,
                    'Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù2': student.grades.semester2?.math || 0,
                    'Ø¹Ù„ÙˆÙ… Ù1': student.grades.semester1?.science || 0,
                    'Ø¹Ù„ÙˆÙ… Ù2': student.grades.semester2?.science || 0,
                    'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù1': student.grades.semester1?.english || 0,
                    'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù2': student.grades.semester2?.english || 0,
                    'Ø¯Ø±Ø§Ø³Ø§Øª Ù1': student.grades.semester1?.social || 0,
                    'Ø¯Ø±Ø§Ø³Ø§Øª Ù2': student.grades.semester2?.social || 0,
                    'Ù…Ø¬Ù…ÙˆØ¹ Ù1': semester1Total,
                    'Ù…Ø¬Ù…ÙˆØ¹ Ù2': semester2Total,
                    'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ': totalGrades,
                    'Ø§Ù„Ù†Ø³Ø¨Ø©': percentage + '%'
                };
            });

            exportToExcelFile(data, 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø¯Ø±Ø¬Ø§Øª');
        }

        // Export semester-only grades as a compact sheet
function exportGradesSemester(semester) {
    const filteredStudents = getFilteredGradesStudents();
    // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„
    const subjects = ['arabic', 'math', 'science', 'english', 'social'];
    const subjectNames = {
        arabic: 'Ø¹Ø±Ø¨ÙŠ',
        math: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
        science: 'Ø¹Ù„ÙˆÙ…',
        english: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ',
        social: 'Ø¯Ø±Ø§Ø³Ø§Øª'
    };
    const semesterLabel = semester === 'semester1' ? 'Ù1' : 'Ù2';

    const data = filteredStudents.map(student => {
        const row = {
            'Ø§Ù„Ø§Ø³Ù…': student.name,
            'Ø§Ù„ØµÙ': student.grade,
            'Ø§Ù„ÙØµÙ„': student.class
        };
        subjects.forEach(sub => {
            row[`${subjectNames[sub]} ${semesterLabel}`] = student.grades[semester]?.[sub] || 0;
        });
        return row;
    });

    const title = semester === 'semester1' ? 'Ø¯Ø±Ø¬Ø§Øª_Ø§Ù„ÙØµÙ„_Ø§Ù„Ø£ÙˆÙ„' : 'Ø¯Ø±Ø¬Ø§Øª_Ø§Ù„ÙØµÙ„_Ø§Ù„Ø«Ø§Ù†ÙŠ';
    exportToExcelFile(data, title);
}

// Export year totals (both semesters combined)
        function exportGradesYearTotal() {
            const filteredStudents = getFilteredGradesStudents();
            const data = filteredStudents.map(student => {
                const s1 = student.grades.semester1 || {};
                const s2 = student.grades.semester2 || {};
                const arabic = (s1.arabic || 0) + (s2.arabic || 0);
                const math = (s1.math || 0) + (s2.math || 0);
                const science = (s1.science || 0) + (s2.science || 0);
                const english = (s1.english || 0) + (s2.english || 0);
                const social = (s1.social || 0) + (s2.social || 0);
                const total = arabic + math + science + english + social; // Ù…Ù† 280
                const percent = Math.round((total / 280) * 100);
                return {
                    'Ø§Ù„Ø§Ø³Ù…': student.name,
                    'Ø§Ù„ØµÙ': getGradeName(student.grade),
                    'Ø§Ù„ÙØµÙ„': `ÙØµÙ„ ${student.class}`,
                    'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹)': arabic,
                    'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹)': math,
                    'Ø§Ù„Ø¹Ù„ÙˆÙ… (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹)': science,
                    'Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹)': english,
                    'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª (Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹)': social,
                    'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù…Ù† 280': total,
                    'Ø§Ù„Ù†Ø³Ø¨Ø©': percent + '%'
                };
            });
            exportToExcelFile(data, 'Ø¯Ø±Ø¬Ø§Øª_Ø§Ù„Ø¹Ø§Ù…_Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹');
        }

        // Reports functions
        function generateReports() {
            generateTopAttendanceReport();
            generateTopGradesReport();
            generateFailedStudentsReport();
        }

        function generateTopAttendanceReport() {
            const filteredStudents = getFilteredReportStudents();
            const studentsWithAttendance = filteredStudents.map(student => {
                const presentDays = calculateStudentPresentDaysInAcademicYear(student.name);
                const totalSchoolDays = calculateTotalSchoolDays();
                const percentage = totalSchoolDays > 0 ? Math.round((presentDays / totalSchoolDays) * 100) : 100;
                return { ...student, attendancePercentage: percentage, presentDays };
            }).sort((a, b) => b.presentDays - a.presentDays).slice(0, 10);

            const container = document.getElementById('top-attendance-report');
            
            if (studentsWithAttendance.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ†</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±</p></div>';
                return;
            }

            container.innerHTML = studentsWithAttendance.map((student, index) => `
                <div class="top-student">
                    <div class="student-rank ${index === 0 ? 'gold' : ''}">${index + 1}</div>
                    <div style="flex: 1;">
                        <h4>${student.name}</h4>
                        <p>${getGradeName(student.grade)} - ÙØµÙ„ ${student.class}</p>
                    </div>
                    <div style="color: #4ecdc4; font-weight: bold; font-size: 1.2rem;">${student.presentDays} ÙŠÙˆÙ…</div>
                </div>
            `).join('');
        }

        function generateTopGradesReport() {
            const filteredStudents = getFilteredReportStudents();
            const studentsWithGrades = filteredStudents.map(student => {
                const maxGrades = { arabic: 80, math: 60, science: 40, english: 60, social: 40 };
                
                let totalGrades = 0;
                let totalMax = 0;
                
                Object.keys(maxGrades).forEach(subject => {
                    const grade1 = student.grades.semester1?.[subject] || 0;
                    const grade2 = student.grades.semester2?.[subject] || 0;
                    const totalGrade = grade1 + grade2;
                    const maxGrade = maxGrades[subject];
                    if (totalGrade > 0) {
                        totalGrades += totalGrade;
                        totalMax += maxGrade;
                    }
                });
                
                const percentage = totalMax > 0 ? Math.round((totalGrades / totalMax) * 100) : 0;
                
                return { ...student, totalGrades, totalMax, percentage };
            }).filter(student => student.totalMax > 0)
              .sort((a, b) => b.percentage - a.percentage).slice(0, 10);

            const container = document.getElementById('top-grades-report');
            
            if (studentsWithGrades.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p></div>';
                return;
            }

            container.innerHTML = studentsWithGrades.map((student, index) => `
                <div class="top-student">
                    <div class="student-rank ${index === 0 ? 'gold' : ''}">${index + 1}</div>
                    <div style="flex: 1;">
                        <h4>${student.name}</h4>
                        <p>${getGradeName(student.grade)} - ÙØµÙ„ ${student.class}</p>
                    </div>
                    <div style="color: #4facfe; font-weight: bold; font-size: 1.2rem;">${student.percentage}%</div>
                </div>
            `).join('');
        }

        function generateFailedStudentsReport() {
            const filteredStudents = getFilteredReportStudents();
            const failedStudents = filteredStudents.filter(student => {
                const maxGrades = { arabic: 80, math: 60, science: 40, english: 60, social: 40 };
                const gradeNames = {
                    arabic: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                    math: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
                    science: 'Ø§Ù„Ø¹Ù„ÙˆÙ…',
                    english: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
                    social: 'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©'
                };
                
                let failedSubjects = [];
                let totalGrades = 0;
                let totalMax = 0;
                
                Object.keys(maxGrades).forEach(subject => {
                    const grade1 = student.grades.semester1?.[subject] || 0;
                    const grade2 = student.grades.semester2?.[subject] || 0;
                    const totalGrade = grade1 + grade2;
                    const maxGrade = maxGrades[subject];
                    if (totalGrade > 0) {
                        totalGrades += totalGrade;
                        totalMax += maxGrade;
                        if (totalGrade < (maxGrade * 0.5)) {
                            failedSubjects.push(gradeNames[subject]);
                        }
                    }
                });
                
                const percentage = totalMax > 0 ? Math.round((totalGrades / totalMax) * 100) : 0;
                const isFailed = failedSubjects.length > 0 || (totalMax > 0 && percentage < 50);
                
                if (isFailed) {
                    student.failedSubjects = failedSubjects;
                    student.percentage = percentage;
                    return true;
                }
                return false;
            });

            const container = document.getElementById('failed-students-report');
            
            if (failedStudents.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø±Ø§Ø³Ø¨ÙˆÙ†</p></div>';
                return;
            }

            container.innerHTML = failedStudents.map(student => `
                <div class="top-student" style="border-right: 4px solid #ff6b6b;">
                    <div class="student-rank" style="background: var(--danger-gradient);">âŒ</div>
                    <div style="flex: 1;">
                        <h4>${student.name}</h4>
                        <p>${getGradeName(student.grade)} - ÙØµÙ„ ${student.class}</p>
                        ${student.failedSubjects.length > 0 ? `<p style="color: #ff6b6b; font-size: 0.9rem;">Ø±Ø§Ø³Ø¨ ÙÙŠ: ${student.failedSubjects.join('ØŒ ')}</p>` : ''}
                    </div>
                    <div style="color: #ff6b6b; font-weight: bold; font-size: 1.2rem;">${student.percentage}%</div>
                </div>
            `).join('');
        }

        function getFilteredReportStudents() {
            const gradeFilter = document.getElementById('reports-grade')?.value;
            const classFilter = document.getElementById('reports-class')?.value;
            
            return students.filter(student => {
                if (student.status !== 'active') return false;
                if (gradeFilter && student.grade != gradeFilter) return false;
                if (classFilter && student.class != classFilter) return false;
                return true;
            }).sort((a, b) => a.name.localeCompare(b.name, 'ar'));
        }

        // Certificate functions
function updateCertificateClasses() {
    const grade = document.getElementById('cert-grade').value;
    const classSelect = document.getElementById('cert-class');
    
    classSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option>';
    
    if (grade) {
        // Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„ØµÙ
        const classCount = grade == 1 ? 15 : 12;
        for (let i = 1; i <= classCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `ÙØµÙ„ ${i}`;
            classSelect.appendChild(option);
        }
    }
    
    updateCertificateStudents();
}

        function updateCertificateStudents() {
            const grade = document.getElementById('cert-grade').value;
            const classNum = document.getElementById('cert-class').value;
            const studentSelect = document.getElementById('cert-student');
            
            studentSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨</option>';
            
            if (grade && classNum) {
                const filteredStudents = students.filter(s => 
                    s.grade == grade && s.class == classNum && s.status === 'active'
                ).sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                
                filteredStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.name;
                    option.textContent = student.name;
                    studentSelect.appendChild(option);
                });
            }
        }

function generateCertificate() {
    const type = document.getElementById('cert-type').value;
    const studentName = document.getElementById('cert-student').value;
    
    if (!studentName) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨');
        return;
    }

    const student = students.find(s => s.name === studentName);
    if (!student) {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨');
        return;
    }

    return type === 'Ù†Ø¬Ø§Ø­' ? generateSuccessCertificate(student) : '';
}  

        function calculateTotal(grades) {
            if (!grades) return '';
            return Object.values(grades).reduce((sum, grade) => sum + (parseInt(grade) || 0), 0);
        }

        function previewCertificate() {
            const studentName = document.getElementById('cert-student').value;
            const certType = document.getElementById('cert-type').value;
            
            if (!studentName || !certType) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            const student = students.find(s => s.name === studentName);
            if (!student) return;
            
            const today = new Date().toLocaleDateString('ar-EG');
            const academicYear = `${settings.academicStart.split('-')[0]}-${settings.academicEnd.split('-')[0]}`;
            
            if (certType === 'efada') {
                document.getElementById('efada-student-name').textContent = student.name;
                document.getElementById('efada-student-grade').textContent = `${getGradeName(student.grade)} - ÙØµÙ„ ${student.class}`;
                document.getElementById('efada-academic-year').textContent = academicYear;
                document.getElementById('efada-birth-date').textContent = (student.birthDate || '').replace(/-/g, '/');
                document.getElementById('efada-issue-date').textContent = today;
                
            } else if (certType === 'bayan') {
                document.getElementById('bayan-student-name').textContent = student.name;
                document.getElementById('bayan-student-grade').textContent = getGradeName(student.grade);
                document.getElementById('bayan-birth-date').textContent = (student.birthDate || '').replace(/-/g, '/');
                document.getElementById('bayan-academic-year').textContent = academicYear;
                document.getElementById('bayan-issue-date').textContent = today;
                document.getElementById('bayan-next-grade').textContent = student.grade < 3 ? getGradeName(parseInt(student.grade) + 1) : 'Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©';
                
                // Set grades
                const subjects = ['arabic', 'english', 'math', 'science', 'social'];
                let total = 0;
                let totalMax = 0;
                
                subjects.forEach(subject => {
                    const grade = student.grades?.[subject] || { semester1: 0, semester2: 0 };
                    const maxGrade = 100;
                    const finalGrade = parseInt(grade.semester1 || 0) + parseInt(grade.semester2 || 0);
                    
                    document.getElementById(`bayan-${subject}-grade`).textContent = finalGrade;
                    document.getElementById(`bayan-${subject}-max`).textContent = maxGrade;
                    
                    total += finalGrade;
                    totalMax += maxGrade;
                });
                
                document.getElementById('bayan-total-grade').textContent = total;
                document.getElementById('bayan-total-max').textContent = totalMax;
            }
            
            document.getElementById('certificate-preview').style.display = 'block';
            document.getElementById('efada-template').style.display = certType === 'efada' ? 'block' : 'none';
            document.getElementById('bayan-template').style.display = certType === 'bayan' ? 'block' : 'none';
        }

function downloadCertificatePDF() {
    const type = document.getElementById('cert-type').value;
    const studentName = document.getElementById('cert-student').value;
    
    if (!studentName) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
        return;
    }

    const student = students.find(s => s.name === studentName);
    if (!student) {
        showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨', 'error');
        return;
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
    const content = generateCertificate();
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${type === 'Ù†Ø¬Ø§Ø­' ? 'Ø¨ÙŠØ§Ù† Ù†Ø¬Ø§Ø­' : 'Ø¥ÙØ§Ø¯Ø©'} - ${student.name}</title>
            <meta charset="UTF-8">
            <style>
                @media print {
                    @page {
                        size: A4;
                        margin: 0;
                    }
                    body {
                        margin: 0;
                        padding: 0;
                    }
                    #certificate-container {
                        width: 21cm;
                        height: 29.7cm;
                        margin: 0 auto;
                        padding: 2cm;
                        background: white;
                    }
                    .certificate-header {
                        text-align: center;
                        margin-bottom: 1cm;
                    }
                    .certificate-header h3 {
                        margin: 0.2cm 0;
                    }
                    .certificate-title {
                        text-align: center;
                        margin: 1cm 0;
                        font-size: 24px;
                    }
                    .certificate-content {
                        line-height: 1.8;
                    }
                    .certificate-content p {
                        margin: 0.3cm 0;
                    }
                    .grades-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 0.5cm;
                    }
                    .grades-table th,
                    .grades-table td {
                        border: 1px solid black;
                        padding: 8px;
                        text-align: center;
                    }
                    .signature-section {
                        margin-top: 2cm;
                        display: flex;
                        justify-content: space-between;
                    }
                }
            </style>
        </head>
        <body dir="rtl">
            ${content}
            <script>
                window.onload = function() {
                    window.print();
                    window.onfocus = function() { window.close(); }
                }
`);
    printWindow.document.close();
}


        // Build a simple daily PDF view for class (name, grade, class, status)
        function downloadDailyAttendancePDF() {
            const grade = document.getElementById('attendance-grade').value;
            const classNum = document.getElementById('attendance-class').value;
            const date = document.getElementById('attendance-date').value;
            if (!grade || !classNum || !date) {
                showToast('Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§Ù„ÙØµÙ„ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            const target = students.filter(s => s.status === 'active' && s.grade == grade && s.class == classNum);
            const win = window.open('', '_blank');
            const title = `ÙƒØ´Ù Ø­Ø¶ÙˆØ± ÙŠÙˆÙ…ÙŠ - ${new Date(date).toLocaleDateString('ar-EG')} - ${getGradeName(parseInt(grade))} - ÙØµÙ„ ${classNum}`;
            let html = `<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>${title}</title>
            <style>body{font-family:'Cairo',Tahoma;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #000;padding:6px;text-align:center;}th{background:#eee;}</style></head><body>`;
            html += `<h3>${title}</h3>`;
            html += `<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„ÙØµÙ„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>`;
            target.forEach(st => {
                const state = (attendanceData[date]?.[st.name]);
                const label = state === 'absent' ? 'ØºØ§Ø¦Ø¨' : (state === 'excused' ? 'ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±' : 'Ø­Ø§Ø¶Ø±');
                html += `<tr><td>${st.name}</td><td>${getGradeName(st.grade)}</td><td>ÙØµÙ„ ${st.class}</td><td>${label}</td></tr>`;
            });
            html += `</tbody></table></body></html>`;
            win.document.write(html);
            win.document.close();
            win.focus();
            win.print();
        }

        // Settings functions
        function saveAcademicYear() {
            settings.academicStart = document.getElementById('academic-start').value;
            settings.academicEnd = document.getElementById('academic-end').value;
            saveData();
            showToast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ', 'success');
            // refresh move-student selector
            populateMoveStudentSelector();
        }

        function promoteStudents() {
            const grade = document.getElementById('promotion-grade').value;
            if (!grade) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            const studentsToPromote = students.filter(s => {
                if (s.grade != grade || s.status !== 'active') return false;
                
                // Check if student is passing with new grade structure
                const maxGrades = { arabic: 80, math: 60, science: 40, english: 60, social: 40 };
                
                let totalGrades = 0;
                let totalMax = 0;
                let failedSubjects = 0;
                
                Object.keys(maxGrades).forEach(subject => {
                    const grade1 = s.grades.semester1?.[subject] || 0;
                    const grade2 = s.grades.semester2?.[subject] || 0;
                    const totalGrade = grade1 + grade2;
                    const maxGrade = maxGrades[subject];
                    if (totalGrade > 0) {
                        totalGrades += totalGrade;
                        totalMax += maxGrade;
                        if (totalGrade < (maxGrade * 0.5)) {
                            failedSubjects++;
                        }
                    }
                });
                
                const percentage = totalMax > 0 ? Math.round((totalGrades / totalMax) * 100) : 0;
                return failedSubjects === 0 && (totalMax === 0 || percentage >= 50);
            });

            if (studentsToPromote.length === 0) {
                showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù†Ø§Ø¬Ø­ÙˆÙ† Ù„Ù„Ù†Ù‚Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØµÙ', 'warning');
                return;
            }

            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†Ù‚Ù„ ${studentsToPromote.length} Ø·Ø§Ù„Ø¨ Ù†Ø§Ø¬Ø­ Ù„Ù„ØµÙ Ø§Ù„ØªØ§Ù„ÙŠØŸ`)) {
                let promotedCount = 0;
                let graduatedCount = 0;

                studentsToPromote.forEach(student => {
                    if (student.grade >= 3) {
                        // Graduate student
                        student.status = 'graduated';
                        graduatedStudents.push({
                            ...student,
                            graduationDate: new Date().toISOString().split('T')[0]
                        });
                        graduatedCount++;
                    } else {
                        // Promote to next grade and reset grades for new year
                        student.grade += 1;
                        student.class = 1; // Reset class
                        student.grades = {
                            semester1: { arabic: null, math: null, science: null, english: null, social: null },
                            semester2: { arabic: null, math: null, science: null, english: null, social: null }
                        };
                        promotedCount++;
                    }
                });

                saveData();
                updateDashboard();
                updateStudentsTable();
                
                let message = '';
                if (promotedCount > 0) message += `ØªÙ… Ù†Ù‚Ù„ ${promotedCount} Ø·Ø§Ù„Ø¨ Ù„Ù„ØµÙ Ø§Ù„ØªØ§Ù„ÙŠ. `;
                if (graduatedCount > 0) message += `ØªÙ… ØªØ®Ø±ÙŠØ¬ ${graduatedCount} Ø·Ø§Ù„Ø¨.`;
                
                showToast(message, 'success');
            }
        }

        // Data import/export functions
        function exportToExcel() {
            const data = students.filter(s => s.status === 'active').map(student => ({
                'Ø§Ù„Ø§Ø³Ù…': student.name,
                'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ': student.nationalId,
                'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ': student.phone,
                'Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±': student.parentPhone,
                'Ø§Ù„ØµÙ': student.grade,
                'Ø§Ù„ÙØµÙ„': student.class,
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯': student.birthDate
            }));

            exportToExcelFile(data, 'Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø·Ù„Ø§Ø¨');
        }

        function exportToExcelFile(data, filename) {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

function importFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);

            let importedCount = 0;
            jsonData.forEach(row => {
                // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø·
                if (row['Ø§Ù„Ø§Ø³Ù…'] && row['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ'] && row['Ø§Ù„ØµÙ'] && row['Ø§Ù„ÙØµÙ„']) {
                    const student = {
                        name: row['Ø§Ù„Ø§Ø³Ù…'],
                        nationalId: row['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ'],
                        phone: row['Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'] || '',
                        parentPhone: row['Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±'] || '',
                        grade: parseInt(row['Ø§Ù„ØµÙ']),
                        class: parseInt(row['Ø§Ù„ÙØµÙ„']),
                        birthDate: row['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯'] || '',
                        attendance: {},
                        grades: {
                            semester1: { arabic: null, math: null, science: null, english: null, social: null },
                            semester2: { arabic: null, math: null, science: null, english: null, social: null }
                        },
                        notes: '',
                        status: 'active'
                    };

                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠØŒ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
                    const existingIndex = students.findIndex(s => s.nationalId === student.nationalId);
                    if (existingIndex === -1) {
                        students.push(student);
                        importedCount++;
                    } else {
                        students[existingIndex] = { ...students[existingIndex], ...student };
                        importedCount++;
                    }
                }
            });

            saveData();
            updateDashboard();
            updateStudentsTable();
            showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ${importedCount} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
        } catch (error) {
            showToast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}
// ...existing code...

        function exportBackup() {
            const backupData = {
                students: students,
                settings: settings,
                attendanceData: attendanceData,
                graduatedStudents: graduatedStudents,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        students = backupData.students || [];
                        settings = backupData.settings || settings;
                        attendanceData = backupData.attendanceData || {};
                        graduatedStudents = backupData.graduatedStudents || [];
                        
                        saveData();
                        updateDashboard();
                        updateStudentsTable();
                        showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        
                        // Refresh page to ensure all data is updated
                        setTimeout(() => location.reload(), 1000);
                    } catch (error) {
                        showToast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
                    }
                };
                reader.readAsText(file);
            }
        }

        function clearAllData() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
                if (confirm('ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!')) {
                    students = [];
                    attendanceData = {};
                    graduatedStudents = [];
                    saveData();
                    updateDashboard();
                    updateStudentsTable();
                    showToast('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            }
        }

        // Utility functions
        function getGradeName(grade) {
            const gradeNames = {
                1: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ',
                2: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ',
                3: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ'
            };
            return gradeNames[grade] || `Ø§Ù„ØµÙ ${grade}`;
        }

        function calculateTotalSchoolDays() {
            const start = new Date(settings.academicStart);
            const academicEnd = new Date(settings.academicEnd);
            const today = new Date();
            const end = academicEnd < today ? academicEnd : today; // limit to today
            let totalDays = 0;
            
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                // Count Sunday (0) to Thursday (4) as school days
                if (dayOfWeek >= 0 && dayOfWeek <= 4) {
                    totalDays++;
                }
            }
            
            return totalDays;
        }

        function calculateStudentAttendance(studentName) {
            let presentDays = 0;
            let totalRecordedDays = 0;
            
            Object.keys(attendanceData).forEach(date => {
                if (attendanceData[date][studentName] !== undefined) {
                    totalRecordedDays++;
                    if (attendanceData[date][studentName] === 'present') {
                        presentDays++;
                    }
                }
            });
            
            // If no attendance records exist, assume 100% for initial display
            if (totalRecordedDays === 0) {
                return calculateTotalSchoolDays(); // Return full days as present
            }
            
            return presentDays;
        }

        // Count present days within the configured academic year (Sun-Thu only)
        function calculateStudentPresentDaysInAcademicYear(studentName) {
            const start = new Date(settings.academicStart);
            const academicEnd = new Date(settings.academicEnd);
            const today = new Date();
            const end = academicEnd < today ? academicEnd : today;
            let presentDays = 0;

            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const iso = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 0 && dayOfWeek <= 4) { // Sun-Thu
                    const state = attendanceData[iso]?.[studentName];
                    // default to present (undefined). Do NOT count excused as present.
                    if (state === 'present' || state === undefined) {
                        presentDays++;
                    }
                }
            }
            return presentDays;
        }

        function calculateStudentExcusedDaysInAcademicYear(studentName) {
            const start = new Date(settings.academicStart);
            const academicEnd = new Date(settings.academicEnd);
            const today = new Date();
            const end = academicEnd < today ? academicEnd : today;
            let excusedDays = 0;
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const iso = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 0 && dayOfWeek <= 4) {
                    if (attendanceData[iso]?.[studentName] === 'excused') excusedDays++;
                }
            }
            return excusedDays;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function toggleTheme() {
            // This is a dark-only theme, so we just show a message
            showToast('Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØµÙ…Ù… Ø¨Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ÙÙ‚Ø·', 'info');
        }

        // Initialize filter dropdowns
        document.addEventListener('DOMContentLoaded', function() {
            // Setup grade change handlers for filters
            document.getElementById('filter-grade').addEventListener('change', updateClassFilter);
document.getElementById('attendance-grade').addEventListener('change', function() {
    const grade = this.value;
    const classSelect = document.getElementById('attendance-class');
    classSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>';
    if (grade) {
        const classCount = grade == 1 ? 15 : 12;
        for (let i = 1; i <= classCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `ÙØµÙ„ ${i}`;
            classSelect.appendChild(option);
        }
    }
});

document.getElementById('grades-grade').addEventListener('change', function() {
    const grade = this.value;
    const classSelect = document.getElementById('grades-class');
    classSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>';
    if (grade) {
        const classCount = grade == 1 ? 15 : 12;
        for (let i = 1; i <= classCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `ÙØµÙ„ ${i}`;
            classSelect.appendChild(option);
        }
    }
});

document.getElementById('reports-grade').addEventListener('change', function() {
    const grade = this.value;
    const classSelect = document.getElementById('reports-class');
    classSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>';
    if (grade) {
        const classCount = grade == 1 ? 15 : 12;
        for (let i = 1; i <= classCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `ÙØµÙ„ ${i}`;
            classSelect.appendChild(option);
        }
    }
});

            populateMoveStudentSelector();
        });

        function populateMoveStudentSelector() {
            const sel = document.getElementById('move-student-select');
            if (!sel) return;
            sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ù†Ù‚Ù„</option>';
            students.filter(s => s.status === 'active').forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                opt.textContent = `${s.name} - ${getGradeName(s.grade)} - ÙØµÙ„ ${s.class}`;
                sel.appendChild(opt);
            });
        }

        function moveStudentToClass() {
            const name = document.getElementById('move-student-select').value;
            const targetClass = parseInt(document.getElementById('move-target-class').value);
            if (!name || !targetClass) {
                showToast('Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            const student = students.find(s => s.name === name);
            if (!student) return;
            student.class = targetClass;
            saveData();
            updateStudentsTable();
            showToast('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„ÙØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'success');
        }

        // Student Card Functions
        let currentCardStudent = null;

        function showStudentCard(studentName) {
            const student = students.find(s => s.name === studentName);
            if (!student) return;

            currentCardStudent = studentName;
            
            // Fill basic info
            document.getElementById('student-card-name').textContent = `Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ - ${student.name}`;
            document.getElementById('card-student-name').textContent = student.name;
            document.getElementById('card-student-id').textContent = student.nationalId;
            document.getElementById('card-student-grade').textContent = getGradeName(student.grade);
            document.getElementById('card-student-class').textContent = `ÙØµÙ„ ${student.class}`;
            document.getElementById('card-student-birth').textContent = (student.birthDate || '').replace(/-/g, '/') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            // gender removed from card UI
            
            // Calculate attendance percentage across the academic year (Sun-Thu)
            const presentDays = calculateStudentPresentDaysInAcademicYear(student.name);
            const totalSchoolDays = calculateTotalSchoolDays() - calculateStudentExcusedDaysInAcademicYear(student.name);
            const attendancePercentage = totalSchoolDays > 0 
                ? Math.round((presentDays / totalSchoolDays) * 100)
                : 100;
            
            document.getElementById('card-student-attendance').textContent = `${attendancePercentage}%`;
            
            // grades removed from card UI
            
            // Notes
            document.getElementById('card-student-notes').value = student.notes || '';
            
            // Show modal
            document.getElementById('student-card-modal').style.display = 'flex';
        }

        function closeStudentCard() {
            document.getElementById('student-card-modal').style.display = 'none';
            currentCardStudent = null;
        }

        function saveStudentNotes() {
            if (!currentCardStudent) return;
            
            const student = students.find(s => s.name === currentCardStudent);
            if (student) {
                student.notes = document.getElementById('card-student-notes').value;
                saveData();
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

function editStudentFromCard() {
    if (!currentCardStudent) return;
    const student = students.find(s => s.name === currentCardStudent);
    if (student) {
        closeStudentCard();
        editStudent(student.name);
    }
}



        function deleteStudentFromCard() {
            if (!currentCardStudent) return;
            
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ "${currentCardStudent}"ØŸ`)) {
                students = students.filter(s => s.name !== currentCardStudent);
                
                // Remove attendance data
                Object.keys(attendanceData).forEach(date => {
                    if (attendanceData[date][currentCardStudent]) {
                        delete attendanceData[date][currentCardStudent];
                    }
                });
                
                saveData();
                updateDashboard();
                updateStudentsTable();
                updateGradesTable();
                closeStudentCard();
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('student-card-modal');
            if (e.target === modal) {
                closeStudentCard();
            }
        });

        // ...existing code...
function checkPassword() {
    const password = document.getElementById('page-password').value;
    // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‡Ù†Ø§
    const correct = "123456";
    if (password === correct) {
        document.getElementById('password-overlay').style.display = 'none';
    } else {
        document.getElementById('password-error').style.display = 'block';
    }
}
document.getElementById('page-password').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        checkPassword();
    }
});

function generateSuccessCertificate(student) {
    const grades = student.grades?.semester2 || {};
    return `
        <div id="certificate-container" style="padding: 20px; font-family: 'Traditional Arabic', 'Times New Roman', serif; direction: rtl; background-color: white;">
            <div style="text-align: center;">
                <p style="margin: 5px 0; font-size: 16pt;">Ù…Ø­Ø§ÙØ¸Ø© ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</p>
                <p style="margin: 5px 0; font-size: 16pt;">Ù…Ø¯ÙŠØ±ÙŠØ© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… Ø¨ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</p>
                <p style="margin: 5px 0; font-size: 16pt;">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø±Ù‚ ÙƒÙØ± Ø§Ù„Ø´ÙŠØ® Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
                <p style="margin: 5px 0; font-size: 16pt;">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø´Ù‡ÙŠØ¯ Ø­Ù…Ø¯ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© Ø¨Ù†ÙŠÙ†</p>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <h2 style="font-size: 18pt; font-weight: bold; margin: 0;">Ø¨ÙŠØ§Ù† Ù†Ø¬Ø§Ø­ Ø¨Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h2>
            </div>

            <div style="margin: 20px 0; line-height: 1.8;">
                <p>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}</p>
                <p>Ù…Ù‚ÙŠØ¯ Ø¨Ø§Ù„ØµÙ: ${getGradeName(student.grade)}</p>
                <p>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: ${student.academicYear || '2025/2026'}</p>
            </div>

            <div style="margin: 20px 0;">
                <p style="margin-bottom: 10px;">ÙˆÙ‚Ø¯ Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
                <table style="width: 100%; border-collapse: collapse; border: 1px solid black;">
                    <tr>
                        <th style="border: 1px solid black; padding: 8px; text-align: center;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">Ø§Ù„Ø¹Ù„ÙˆÙ…</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</td>
                    </tr>
                    <tr>
                        <th style="border: 1px solid black; padding: 8px; text-align: center;">Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ø¸Ù…Ù‰</th>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">60</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">60</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">60</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">60</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">60</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">300</td>
                    </tr>
                    <tr>
                        <th style="border: 1px solid black; padding: 8px; text-align: center;">Ø¯Ø±Ø¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${grades.arabic || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${grades.math || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${grades.science || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${grades.english || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${grades.social || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${calculateTotal(grades)}</td>
                    </tr>
                </table>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 80px;">
                <div style="text-align: center;">
                    <p style="margin-bottom: 40px;">Ø´Ø¦ÙˆÙ† Ø§Ù„Ø·Ù„Ø¨Ø©</p>
                    <p>_____________</p>
                </div>
                <div style="text-align: center;">
                    <p style="margin-bottom: 40px;">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p>
                    <p>_____________</p>
                </div>
            </div>
        </div>
    `;
}

// ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function exportData() {
    try {
        showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
        const exportData = {
            students: students,
            attendanceData: attendanceData,
            settings: settings,
            graduatedStudents: graduatedStudents,
            exportDate: new Date().toISOString(),
            version: '1.0'
        };

        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `school_backup_${new Date().toLocaleDateString('ar-EG')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function importData(event) {
    try {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.name.endsWith('.json')) {
            showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù JSON ØµØ­ÙŠØ­', 'error');
            return;
        }

        showToast('Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...', 'info');
        const reader = new FileReader();

        reader.onload = async function(e) {
            try {
                const data = JSON.parse(e.target.result);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!data.students || !Array.isArray(data.students)) {
                    throw new Error('ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­');
                }

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                students = data.students;
                attendanceData = data.attendanceData || {};
                settings = data.settings || settings;
                graduatedStudents = data.graduatedStudents || [];

                // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
                saveData();

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                updateDashboard();
                updateStudentsTable();
                showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
                setTimeout(() => window.location.reload(), 1000);
            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù:', err);
                showToast('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù', 'error');
            }
        };

        reader.onerror = function() {
            showToast('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error');
        };

        reader.readAsText(file);
    } catch (err) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
}


    </script>
</body>
</html>