<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة شؤون الطلاب - نسخة ثابتة</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- نفس محتوى index.html -->
    <script>
    // نظام إدارة البيانات المحلية
    const storage = {
        saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                return false;
            }
        },
        
        getData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('خطأ في قراءة البيانات:', error);
                return null;
            }
        },

        clearData() {
            try {
                localStorage.clear();
                return true;
            } catch (error) {
                console.error('خطأ في مسح البيانات:', error);
                return false;
            }
        }
    };

    // البيانات الافتراضية
    const defaultData = {
        settings: {
            academicStart: '2025-09-01',
            academicEnd: '2026-05-31',
            schoolName: 'مدرسة الشهيد حمدي إبراهيم الإعدادية بنين',
            schoolLogo: 'logo1.png'
        },
        students: [],
        attendanceData: {},
        graduatedStudents: []
    };

    // تهيئة البيانات
    let students = storage.getData('students') || defaultData.students;
    let settings = storage.getData('settings') || defaultData.settings;
    let attendanceData = storage.getData('attendanceData') || defaultData.attendanceData;
    let graduatedStudents = storage.getData('graduatedStudents') || defaultData.graduatedStudents;

    // وظائف إدارة البيانات
    function saveData() {
        storage.saveData('students', students);
        storage.saveData('settings', settings);
        storage.saveData('attendanceData', attendanceData);
        storage.saveData('graduatedStudents', graduatedStudents);
    }

    function loadData() {
        students = storage.getData('students') || defaultData.students;
        settings = storage.getData('settings') || defaultData.settings;
        attendanceData = storage.getData('attendanceData') || defaultData.attendanceData;
        graduatedStudents = storage.getData('graduatedStudents') || defaultData.graduatedStudents;
        
        updateDashboard();
        updateStudentsTable();
        setCurrentDate();
    }

    // حفظ البيانات تلقائياً عند أي تغيير
    function autoSave() {
        saveData();
    }

    // تصدير البيانات كنسخة احتياطية
    function exportBackup() {
        const backup = {
            students,
            settings,
            attendanceData,
            graduatedStudents,
            exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "school_backup_" + new Date().toISOString().split('T')[0] + ".json";
        a.click();
        URL.revokeObjectURL(url);
    }

    // استيراد نسخة احتياطية
    async function importBackup(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
            const text = await file.text();
            const backup = JSON.parse(text);
            
            if (backup.students && backup.settings && backup.attendanceData) {
                students = backup.students;
                settings = backup.settings;
                attendanceData = backup.attendanceData;
                graduatedStudents = backup.graduatedStudents || [];
                
                saveData();
                loadData();
                showToast('تم استيراد النسخة الاحتياطية بنجاح', 'success');
            } else {
                showToast('ملف النسخة الاحتياطية غير صالح', 'error');
            }
        } catch (error) {
            console.error('خطأ في استيراد النسخة الاحتياطية:', error);
            showToast('حدث خطأ أثناء استيراد النسخة الاحتياطية', 'error');
        }
    }

    // تعديل دالة تحويل التاريخ لإخراج النتيجة بالشكل yyyy/mm/dd
    function excelDateToJSDate(serial) {
        if (typeof serial === 'string' && serial.match(/^\d{4}-\d{2}-\d{2}$/)) {
            // إذا كان نص تاريخ جاهز (yyyy-mm-dd)
            return serial.replace(/-/g, '/');
        }
        if (typeof serial === 'string' && serial.match(/^\d{4}\/\d{2}\/\d{2}$/)) {
            // إذا كان نص تاريخ جاهز (yyyy/mm/dd)
            return serial;
        }
        if (typeof serial === 'number' && serial > 59) serial -= 1; // Excel leap year bug
        var utc_days = Math.floor(serial - 25569);
        var utc_value = utc_days * 86400; // seconds
        var date_info = new Date(utc_value * 1000);
        var yyyy = date_info.getUTCFullYear();
        var mm = String(date_info.getUTCMonth() + 1).padStart(2, '0');
        var dd = String(date_info.getUTCDate()).padStart(2, '0');
        return `${yyyy}/${mm}/${dd}`;
    }

    function updateStudentsTable() {
        const tbody = document.getElementById('students-table-body');
        if (!tbody) return;
        const filteredStudents = students; // أو استخدم الفلترة حسب الحاجة
        tbody.innerHTML = filteredStudents.map(student => `
            <tr>
                <td>${student.name}</td>
                <td>${student.grade}</td>
                <td>${student.class}</td>
                <td>${excelDateToJSDate(student.birthDate)}</td>
                <td>${student.parentPhone || ''}</td>
                <td>${student.nationalId || ''}</td>
                <td>
                    <button onclick="editStudent('${student.name}')">تعديل</button>
                    <button onclick="deleteStudent('${student.name}')">حذف</button>
                </td>
            </tr>
        `).join('');
    }

    function showStudentCard(studentName) {
        const student = students.find(s => s.name === studentName);
        if (!student) return;
        
        document.getElementById('student-card-name').textContent = student.name;
        document.getElementById('student-card-grade').textContent = student.grade;
        document.getElementById('student-card-class').textContent = student.class;
        document.getElementById('student-card-birth').textContent = excelDateToJSDate(student.birthDate) || 'غير محدد';
        document.getElementById('student-card-phone').textContent = student.parentPhone || 'غير محدد';
        document.getElementById('student-card-national-id').textContent = student.nationalId || 'غير محدد';
        
        // عرض بطاقة الطالب
        document.getElementById('student-card').style.display = 'block';
    }

    // تحميل البيانات عند بدء التطبيق
    document.addEventListener('DOMContentLoaded', loadData);

    // حفظ البيانات عند إغلاق التطبيق
    window.addEventListener('beforeunload', saveData);

</script>
</body>
</html>